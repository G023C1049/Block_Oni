This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
- Pay special attention to the Repository Description. These contain important context and guidelines specific to this project.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: unity/My project/Assets/Scripts/**/*.cs, unity/My project/Assets/FlutterUnityIntegration/**/*.cs, lib/**/*.dart, pubspec.yaml
- Files matching these patterns are excluded: **/*.meta, **/*.mat, **/*.prefab, **/*.unity, **/*.asset, **/Library/, **/Temp/, **/Obj/, **/Build/, **/Logs/, **/UserSettings/, **/.dart_tool/, **/build/, **/.flutter-plugins, **/.flutter-plugins-dependencies, **/*.png, **/*.jpg, **/*.jpeg, **/*.gif, **/*.bmp, **/*.tga, **/*.mp3, **/*.wav, **/*.ogg, **/*.fbx, **/*.obj, **/*.blend, **/*.ttf, **/*.otf
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<user_provided_header>
Unity + Flutter Project Codebase
</user_provided_header>

<directory_structure>
lib/main.dart
lib/models/game_data.dart
lib/models/item.dart
lib/models/player.dart
lib/overlays/global_overlay.dart
lib/providers/game_rule_manager.dart
lib/providers/group_provider.dart
lib/providers/lobby_view_model.dart
lib/providers/user_provider.dart
lib/screens/game_screen.dart
lib/screens/lobby_screen.dart
lib/screens/settings_overlay.dart
lib/screens/title_screen.dart
lib/screens/waiting_room_screen.dart
lib/services/socket_service.dart
lib/services/unity_bridge_service.dart
lib/utils/validators.dart
pubspec.yaml
unity/My project/Assets/FlutterUnityIntegration/Editor/Build.cs
unity/My project/Assets/FlutterUnityIntegration/Editor/SweetShellHelper.cs
unity/My project/Assets/FlutterUnityIntegration/Editor/XCodePostBuild.cs
unity/My project/Assets/FlutterUnityIntegration/NativeAPI.cs
unity/My project/Assets/FlutterUnityIntegration/SingletonMonoBehaviour.cs
unity/My project/Assets/FlutterUnityIntegration/UnityMessageManager.cs
unity/My project/Assets/Scripts/Common/Models.cs
unity/My project/Assets/Scripts/Game/CameraController.cs
unity/My project/Assets/Scripts/Game/MapGenerator.cs
unity/My project/Assets/Scripts/Game/MoveCalculator.cs
unity/My project/Assets/Scripts/Game/PlayerController.cs
unity/My project/Assets/Scripts/Game/Square.cs
unity/My project/Assets/Scripts/Managers/GameManager.cs
unity/My project/Assets/Scripts/utils/ArrowSelector.cs
unity/My project/Assets/Scripts/utils/Billboard.cs
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="lib/providers/group_provider.dart">
import 'package:flutter/material.dart';

// Groupãƒ¢ãƒ‡ãƒ«å®šç¾©
class Group {
  final String id;
  final String name;
  final String? password;
  List<String> members;
  // chatHistoryã‚’å‰Šé™¤ã—ã¾ã—ãŸ

  Group({
    required this.id,
    required this.name,
    this.password,
    required this.members,
  });
}

class GroupProvider with ChangeNotifier {
  final List<Group> _groups = [];
  Group? _currentGroup;

  Group? get currentGroup => _currentGroup;
  List<Group> get allGroups => _groups;

  // 1. æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
  Future<String> createGroup(String groupName, String? password, String playerName) async {
    // IDç”Ÿæˆï¼ˆç°¡æ˜“çš„ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãªã©ã‚’ä½¿ç”¨ï¼‰
    final String newId = (1000 + _groups.length).toString();
    
    final newGroup = Group(
      id: newId,
      name: groupName,
      password: password,
      members: [playerName], // ä½œæˆè€…ã‚’æœ€åˆã®ãƒ¡ãƒ³ãƒãƒ¼ã«è¿½åŠ 
    );

    _groups.add(newGroup);
    _currentGroup = newGroup;
    notifyListeners();
    return newId;
  }

  // 2. ã‚°ãƒ«ãƒ¼ãƒ—å‚åŠ 
  Future<bool> joinGroup(String groupId, String? inputPass, String playerName) async {
    try {
      // IDã§æ¤œç´¢
      final group = _groups.firstWhere((g) => g.id == groupId);

      // ãƒã‚§ãƒƒã‚¯å‡¦ç†
      if (group.members.length >= 4) return false; // æº€å“¡
      if (group.password != null && group.password!.isNotEmpty) {
         if (group.password != inputPass) return false; // ãƒ‘ã‚¹ä¸ä¸€è‡´
      }

      // ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
      group.members.add(playerName);
      _currentGroup = group;
      notifyListeners();
      return true;
    } catch (e) {
      // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆãªã©
      return false;
    }
  }

  // 3. ã‚°ãƒ«ãƒ¼ãƒ—é€€å‡º
  void leaveGroup(String playerName) {
    if (_currentGroup != null) {
      _currentGroup!.members.remove(playerName);
      if (_currentGroup!.members.isEmpty) {
        _groups.remove(_currentGroup);
      }
      _currentGroup = null;
      notifyListeners();
    }
  }
}
</file>

<file path="lib/providers/lobby_view_model.dart">
import 'package:flutter/material.dart';
import 'group_provider.dart';

class LobbyViewModel with ChangeNotifier {
  List<Group> _searchResults = [];
  List<Group> get searchResults => _searchResults;

  // 1. ã‚°ãƒ«ãƒ¼ãƒ—æ¤œç´¢ (IDã®éƒ¨åˆ†ä¸€è‡´)
  void searchGroup(String keyword, List<Group> allGroups) {
    if (keyword.isEmpty) {
      _searchResults = [];
    } else {
      _searchResults = allGroups
          .where((g) => g.id.contains(keyword) || g.name.contains(keyword))
          .toList();
    }
    notifyListeners();
  }
}
</file>

<file path="lib/screens/waiting_room_screen.dart">
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/group_provider.dart';
import '../providers/user_provider.dart';

class WaitingRoomScreen extends StatelessWidget {
  const WaitingRoomScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final groupProvider = context.watch<GroupProvider>();
    final userProvider = context.read<UserProvider>();
    final group = groupProvider.currentGroup;

    // ã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã‚‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆé€šå¸¸ã‚ã‚Šãˆãªã„ãŒå¿µã®ãŸã‚ï¼‰
    if (group == null) {
      return Scaffold(
        appBar: AppBar(title: const Text('ã‚¨ãƒ©ãƒ¼')),
        body: const Center(child: Text('ã‚°ãƒ«ãƒ¼ãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')),
      );
    }

    return Scaffold(
      appBar: AppBar(
        title: Text('å¾…æ©Ÿå®¤: ${group.name} (ID: ${group.id})'),
        backgroundColor: Colors.cyan,
        foregroundColor: Colors.white,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back),
          onPressed: () {
            // é€€å‡ºå‡¦ç†
            groupProvider.leaveGroup(userProvider.username);
            Navigator.of(context).pop();
          },
        ),
      ),
      body: Column(
        children: [
          const SizedBox(height: 20),
          const Text(
            "å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼",
            style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 10),
          
          // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆè¡¨ç¤º
          Expanded(
            child: ListView.builder(
              padding: const EdgeInsets.all(16),
              itemCount: group.members.length,
              itemBuilder: (context, index) {
                final memberName = group.members[index];
                final isMe = memberName == userProvider.username;
                
                return Card(
                  child: ListTile(
                    leading: const Icon(Icons.person),
                    title: Text(
                      memberName,
                      style: TextStyle(
                        fontWeight: isMe ? FontWeight.bold : FontWeight.normal,
                        color: isMe ? Colors.cyan : Colors.black,
                      ),
                    ),
                    trailing: index == 0 ? const Chip(label: Text("ãƒ›ã‚¹ãƒˆ")) : null,
                  ),
                );
              },
            ),
          ),

          // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢
          Padding(
            padding: const EdgeInsets.all(20.0),
            child: SizedBox(
              width: double.infinity,
              height: 50,
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.orangeAccent,
                  foregroundColor: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
                onPressed: () {
                  // ã‚²ãƒ¼ãƒ ç”»é¢ã¸é·ç§»
                  Navigator.pushNamed(context, '/game');
                },
                child: const Text(
                  "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼",
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}
</file>

<file path="lib/overlays/global_overlay.dart">
import 'package:flutter/material.dart';
import '../main.dart'; // navigatorKeyã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚

class GlobalOverlay {
  static final GlobalOverlay _instance = GlobalOverlay._internal();
  factory GlobalOverlay() => _instance;
  GlobalOverlay._internal();

  OverlayEntry? _entry;

  void show({required Widget child}) {
    if (_entry != null) return; // æ—¢ã«è¡¨ç¤ºä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„

    final overlayState = navigatorKey.currentState?.overlay;
    if (overlayState == null) return;

    _entry = OverlayEntry(
      builder: (_) => Stack(
        children: [
          // èƒŒæ™¯ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ãŸã‚ã®é€æ˜ãƒ¬ã‚¤ãƒ¤ãƒ¼
          Positioned.fill(
            child: GestureDetector(
              onTap: hide,
              child: Container(color: Colors.black54),
            ),
          ),
          // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
          Center(child: child),
        ],
      ),
    );

    overlayState.insert(_entry!);
  }

  void hide() {
    _entry?.remove();
    _entry = null;
  }
}
</file>

<file path="lib/providers/user_provider.dart">
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import '../services/unity_bridge_service.dart';

/// æ‹…å½“: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ»è¨­å®šç®¡ç†ã‚¯ãƒ©ã‚¹
/// è²¬å‹™: ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã¨ Unity ã¸ã®åŒæœŸ
class UserProvider extends ChangeNotifier {
  final UnityBridgeService _unityBridge;
  final SharedPreferences _prefs; // å¤–éƒ¨ã‹ã‚‰æ³¨å…¥ã•ã‚Œã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹
  String _username = '';

  // è¨­å®šçŠ¶æ…‹
  String _quality = 'ä¸­';
  bool _soundEnabled = true;
  bool _vcEnabled = true;

  // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ UnityBridge ã¨ SharedPreferences ã®ä¸¡æ–¹ã‚’å—ã‘å–ã‚‹
  UserProvider(this._unityBridge, this._prefs) {
    _loadSettings();
  }

  // ã‚²ãƒƒã‚¿ãƒ¼
  String get username => _username;
  String get quality => _quality;
  bool get soundEnabled => _soundEnabled;
  bool get vcEnabled => _vcEnabled;

  /// åˆæœŸåŒ–æ™‚ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–æ¸ˆã¿ã® _prefs ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€
  void _loadSettings() {
    _username = _prefs.getString('user_name') ?? '';
    _quality = _prefs.getString('quality') ?? 'ä¸­';
    _soundEnabled = _prefs.getBool('sound_enabled') ?? true;
    _vcEnabled = _prefs.getBool('vc_enabled') ?? true;
    
    // åˆæœŸåŒ–å®Œäº†ã‚’é€šçŸ¥
    notifyListeners();
  }

  /// ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ä¿å­˜å‡¦ç†
  /// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: 1~12æ–‡å­—ã€ç©ºç™½ã®ã¿ä¸å¯ã€çµµæ–‡å­—ä¸å¯ï¼ˆç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼‰
  Future<bool> saveUsername(String name) async {
    final trimmedName = name.trim();
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯: ç©ºæ–‡å­—ã€12æ–‡å­—è¶…é
    if (trimmedName.isEmpty || trimmedName.length > 12) {
      return false; 
    }

    // çµµæ–‡å­—ãƒã‚§ãƒƒã‚¯ (ç°¡æ˜“ç‰ˆ: ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ãŒå«ã¾ã‚Œã‚‹ã‹ç¢ºèª)
    if (trimmedName.runes.any((rune) => rune > 0xFFFF)) {
      return false;
    }

    try {
      // æ—¢ã«ä¿æŒã—ã¦ã„ã‚‹ _prefs ã‚’ä½¿ç”¨
      await _prefs.setString('user_name', trimmedName);
      _username = trimmedName;

      // ä¿å­˜æˆåŠŸå¾Œã€Unityå´ã«åå‰æƒ…å ±ã‚’é€ä¿¡
      _unityBridge.sendToUnity("UpdatePlayerName", {"name": trimmedName});
      
      notifyListeners();
      return true;
    } catch (e) {
      debugPrint("Error saving username: $e");
      return false;
    }
  }

  /// è¨­å®šã®æ›´æ–°å‡¦ç†
  Future<void> updateSettings({
    String? quality,
    bool? soundEnabled,
    bool? vcEnabled,
  }) async {
    if (quality != null) {
      _quality = quality;
      await _prefs.setString('quality', _quality);
    }
    if (soundEnabled != null) {
      _soundEnabled = soundEnabled;
      await _prefs.setBool('sound_enabled', _soundEnabled);
    }
    if (vcEnabled != null) {
      _vcEnabled = vcEnabled;
      await _prefs.setBool('vc_enabled', _vcEnabled);
    }

    // Unityå´ã®è¨­å®šã‚’æ›´æ–°
    _unityBridge.sendToUnity("UpdateEngineSettings", {
      "quality": _quality,
      "audioVolume": _soundEnabled ? 1.0 : 0.0,
      "vcActive": _vcEnabled,
    });

    notifyListeners();
  }
}
</file>

<file path="lib/screens/game_screen.dart">
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter_unity_widget/flutter_unity_widget.dart';
// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã«åˆã‚ã›ã¦ãƒ‘ã‚¹ã‚’èª¿æ•´ã—ã¦ãã ã•ã„
import '../providers/game_rule_manager.dart';

class GameScreen extends StatefulWidget {
  const GameScreen({Key? key}) : super(key: key);

  @override
  State<GameScreen> createState() => _GameScreenState();
}

class _GameScreenState extends State<GameScreen> {
  UnityWidgetController? _unityWidgetController;
  final GameRuleManager _ruleManager = GameRuleManager();

  final List<String> _gameLogs = [
    "ã‚·ã‚¹ãƒ†ãƒ : ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã€‚",
    "ã‚·ã‚¹ãƒ†ãƒ : 10ã‚¿ãƒ¼ãƒ³é€ƒã’åˆ‡ã‚Œã°é€ƒèµ°è€…ã®å‹ã¡ã§ã™ã€‚",
  ];

  final ScrollController _scrollController = ScrollController();
  bool _isDiceRolled = false;

  @override
  void dispose() {
    _unityWidgetController?.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  void _onUnityCreated(controller) {
    _unityWidgetController = controller;
  }

  void _onUnityMessage(message) {
    try {
      var data = jsonDecode(message.toString());

      if (data['type'] == 'StatusUpdate') {
        setState(() {
          _ruleManager.gameStatusMessage = data['message'];
        });
        return;
      }

      String? logMessage = _ruleManager.handleUnityMessage(data);
      if (logMessage != null) {
        _addLog(logMessage);
      }
      setState(() {});

    } catch (e) {
      _addLog("Error: $message");
    }
  }

  void _addLog(String text) {
    setState(() {
      _gameLogs.add(text);
    });
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (_scrollController.hasClients) {
        _scrollController.animateTo(
          _scrollController.position.maxScrollExtent,
          duration: const Duration(milliseconds: 300),
          curve: Curves.easeOut,
        );
      }
    });
  }

  void _handleDiceRoll() {
    if (_isDiceRolled) return;

    _addLog("ğŸ² ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã£ã¦ã„ã¾ã™...");
    _ruleManager.rollDice(_unityWidgetController);

    setState(() {
      _isDiceRolled = true;
    });

    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        setState(() {
          _isDiceRolled = false;
        });
      }
    });
  }

  void _handleUseItem(String itemId, String itemName) {
    if (_unityWidgetController == null) return;
    
    int count = _ruleManager.currentInventory[itemId] ?? 0;
    
    if (count <= 0) {
      _addLog("âŒ $itemName ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ï¼");
      return;
    }

    _addLog("âœ¨ ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨: $itemName");
    _ruleManager.useItem(_unityWidgetController, itemId);
    
    setState(() {}); 
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤'),
        backgroundColor: const Color(0xFF252525),
        foregroundColor: Colors.white,
      ),
      body: Row(
        children: [
          Expanded(
            flex: 7,
            child: Container(
              color: Colors.black,
              child: UnityWidget(
                onUnityCreated: _onUnityCreated,
                onUnityMessage: _onUnityMessage,
                useAndroidViewSurface: true,
                fullscreen: false,
              ),
            ),
          ),
          Expanded(
            flex: 3,
            child: Container(
              decoration: const BoxDecoration(
                color: Color(0xFF252525),
                border: Border(left: BorderSide(color: Colors.grey, width: 1)),
              ),
              child: Column(
                children: [
                  _buildStatusHeader(),
                  const Divider(color: Colors.grey, height: 1),
                  Expanded(child: _buildLogView()),
                  const Divider(color: Colors.grey, height: 1),
                  _buildExpandableItemArea(),
                  const Divider(color: Colors.grey, height: 1),
                  _buildActionArea(),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStatusHeader() {
    return Padding(
      padding: const EdgeInsets.all(12.0),
      child: Column(
        children: [
          const Text("GAME INFO", style: TextStyle(color: Colors.grey, fontSize: 10)),
          const SizedBox(height: 4),
          FittedBox(
            fit: BoxFit.scaleDown,
            child: Text(
              _ruleManager.gameStatusMessage,
              style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildLogView() {
    return ListView.builder(
      controller: _scrollController,
      padding: const EdgeInsets.all(8),
      itemCount: _gameLogs.length,
      itemBuilder: (context, index) {
        return Padding(
          padding: const EdgeInsets.only(bottom: 4.0),
          child: Text(
            _gameLogs[index],
            style: const TextStyle(color: Colors.white70, fontSize: 12),
          ),
        );
      },
    );
  }

  Widget _buildExpandableItemArea() {
    return Theme(
      data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
      child: ExpansionTile(
        title: const Text("ITEMS", style: TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Colors.white)),
        subtitle: const Text("ã‚¿ãƒƒãƒ—ã—ã¦å±•é–‹", style: TextStyle(fontSize: 10, color: Colors.grey)),
        initiallyExpanded: false,
        children: [
          Container(
            height: 100, 
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 8),
            color: Colors.black12,
            child: ListView(
              scrollDirection: Axis.horizontal,
              children: [
                _buildItemButton("SpeedUp", "åŠ é€Ÿ(+2)", Icons.flash_on, Colors.yellow),
                const SizedBox(width: 8),
                _buildItemButton("Teleport", "ãƒ¯ãƒ¼ãƒ—", Icons.wifi_tethering, Colors.purpleAccent),
                const SizedBox(width: 8),
                _buildItemButton("StageRotate", "å›è»¢", Icons.rotate_right, Colors.orange),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildItemButton(String id, String name, IconData icon, Color color) {
    int count = _ruleManager.currentInventory[id] ?? 0;
    bool hasItem = count > 0;

    return InkWell(
      onTap: hasItem ? () => _handleUseItem(id, name) : null,
      child: Container(
        width: 70, 
        decoration: BoxDecoration(
          color: hasItem ? color.withOpacity(0.2) : Colors.black26,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: hasItem ? color : Colors.grey),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, color: hasItem ? color : Colors.grey, size: 24),
            const SizedBox(height: 2),
            FittedBox(
              fit: BoxFit.scaleDown,
              child: Text(name, style: TextStyle(color: hasItem ? Colors.white : Colors.grey, fontSize: 10)),
            ),
            Text("x$count", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 10)),
          ],
        ),
      ),
    );
  }

  Widget _buildActionArea() {
    return Container(
      padding: const EdgeInsets.all(12.0),
      child: SizedBox(
        width: double.infinity,
        height: 50,
        child: ElevatedButton.icon(
          onPressed: _isDiceRolled ? null : _handleDiceRoll,
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.blueAccent,
            foregroundColor: Colors.white,
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            padding: const EdgeInsets.symmetric(horizontal: 8),
          ),
          icon: const Icon(Icons.casino, size: 24),
          label: const Flexible(
            child: FittedBox(
              fit: BoxFit.scaleDown,
              child: Text("ROLL DICE", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
            ),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/screens/lobby_screen.dart">
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/group_provider.dart';
import '../providers/lobby_view_model.dart';
import '../providers/user_provider.dart';
import '../screens/settings_overlay.dart'; // è¨­å®šç”»é¢
import '../overlays/global_overlay.dart'; // Overlayç®¡ç†

class LobbyScreen extends StatefulWidget {
  const LobbyScreen({super.key});

  @override
  State<LobbyScreen> createState() => _LobbyScreenState();
}

class _LobbyScreenState extends State<LobbyScreen> {
  final TextEditingController _searchCtrl = TextEditingController();

  @override
  Widget build(BuildContext context) {
    final groupProvider = context.watch<GroupProvider>();
    final lobbyVM = context.watch<LobbyViewModel>();
    final userProvider = context.read<UserProvider>();

    return Scaffold(
      appBar: AppBar(
        title: const Text('ãƒ­ãƒ“ãƒ¼'),
        backgroundColor: Colors.cyan,
        foregroundColor: Colors.white,
        actions: [
          // è¨­å®šãƒœã‚¿ãƒ³
          IconButton(
            icon: const Icon(Icons.settings),
            onPressed: () {
              GlobalOverlay().show(child: const SettingsOverlay());
            },
          ),
        ],
      ),
      body: Row(
        children: [
          // å·¦å´ï¼šã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã‚¨ãƒªã‚¢
          Expanded(
            flex: 6,
            child: Container(
              color: Colors.grey[100],
              padding: const EdgeInsets.all(16.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text('ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§', style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
                  const SizedBox(height: 10),
                  
                  // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹
                  TextField(
                    controller: _searchCtrl,
                    decoration: InputDecoration(
                      hintText: 'ID ã¾ãŸã¯ éƒ¨å±‹åã§æ¤œç´¢',
                      prefixIcon: const Icon(Icons.search),
                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                      filled: true,
                      fillColor: Colors.white,
                    ),
                    onChanged: (val) {
                      lobbyVM.searchGroup(val, groupProvider.allGroups);
                    },
                  ),
                  const SizedBox(height: 10),

                  // ãƒªã‚¹ãƒˆè¡¨ç¤º
                  Expanded(
                    child: _buildGroupList(groupProvider, lobbyVM, userProvider),
                  ),
                ],
              ),
            ),
          ),

          // å³å´ï¼šæ“ä½œã‚¨ãƒªã‚¢
          Expanded(
            flex: 4,
            child: Container(
              color: Colors.white,
              // â˜…é‡è¦: ã“ã“ã‚’SingleChildScrollViewã§ãƒ©ãƒƒãƒ—ã—ã¦ã€ç”»é¢ãŒå°ã•ãã¦ã‚‚ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã•ã›ãªã„
              child: SingleChildScrollView(
                child: Padding(
                  padding: const EdgeInsets.all(24.0),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Icon(Icons.sports_esports, size: 80, color: Colors.cyan),
                      const SizedBox(height: 20),
                      Text("ã‚ˆã†ã“ã\n${userProvider.username} ã•ã‚“", 
                        textAlign: TextAlign.center,
                        style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold)
                      ),
                      const SizedBox(height: 40), 
                      
                      // æ–°è¦ä½œæˆãƒœã‚¿ãƒ³
                      SizedBox(
                        width: double.infinity,
                        height: 50,
                        child: ElevatedButton.icon(
                          icon: const Icon(Icons.add),
                          label: const Text('ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.orangeAccent,
                            foregroundColor: Colors.white,
                          ),
                          onPressed: () => _showCreateDialog(context, groupProvider, userProvider),
                        ),
                      ),
                      const SizedBox(height: 20),
                      
                      // æˆ»ã‚‹ãƒœã‚¿ãƒ³
                      SizedBox(
                        width: double.infinity,
                        child: OutlinedButton(
                          onPressed: () => Navigator.pop(context),
                          child: const Text('æˆ»ã‚‹'),
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildGroupList(GroupProvider groupProvider, LobbyViewModel lobbyVM, UserProvider userProvider) {
    final displayList = _searchCtrl.text.isNotEmpty 
        ? lobbyVM.searchResults 
        : groupProvider.allGroups;

    if (displayList.isEmpty) {
      return const Center(child: Text("ã‚°ãƒ«ãƒ¼ãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"));
    }

    return ListView.builder(
      itemCount: displayList.length,
      itemBuilder: (context, index) {
        final group = displayList[index];
        return Card(
          margin: const EdgeInsets.only(bottom: 8),
          child: ListTile(
            title: Text(group.name, style: const TextStyle(fontWeight: FontWeight.bold)),
            subtitle: Text("ID: ${group.id} / å‚åŠ : ${group.members.length}äºº"),
            trailing: ElevatedButton(
              child: const Text("å‚åŠ "),
              onPressed: () async {
                String? inputPass;
                if (group.password != null && group.password!.isNotEmpty) {
                  inputPass = await _showPasswordInputDialog(context);
                  if (inputPass == null) return;
                }

                if (!mounted) return;
                bool success = await groupProvider.joinGroup(group.id, inputPass, userProvider.username);
                
                if (success && mounted) {
                   Navigator.pushNamed(context, '/waiting');
                } else if (mounted) {
                   ScaffoldMessenger.of(context).showSnackBar(
                     const SnackBar(content: Text("å‚åŠ ã§ãã¾ã›ã‚“ã§ã—ãŸ")),
                   );
                }
              },
            ),
          ),
        );
      },
    );
  }

  void _showCreateDialog(BuildContext context, GroupProvider groupProvider, UserProvider userProvider) {
    final nameCtrl = TextEditingController();
    final passCtrl = TextEditingController();

    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ'),
        // â˜…é‡è¦: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ä¸­èº«ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã—ã¦ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’é˜²ã
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              TextField(
                controller: nameCtrl, 
                decoration: const InputDecoration(labelText: 'ã‚°ãƒ«ãƒ¼ãƒ—å'),
              ),
              const SizedBox(height: 10),
              TextField(
                controller: passCtrl, 
                decoration: const InputDecoration(labelText: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ä»»æ„)'),
              ),
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
          ),
          ElevatedButton(
            onPressed: () async {
              if (nameCtrl.text.isEmpty) return;
              await groupProvider.createGroup(nameCtrl.text, passCtrl.text, userProvider.username);
              if (!mounted) return;
              Navigator.pop(ctx);
              Navigator.pushNamed(context, '/waiting');
            },
            child: const Text('ä½œæˆ'),
          ),
        ],
      ),
    );
  }

  Future<String?> _showPasswordInputDialog(BuildContext context) async {
    String? result;
    final ctrl = TextEditingController();
    await showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›'),
        content: TextField(
          controller: ctrl, 
          obscureText: true, 
          decoration: const InputDecoration(hintText: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›'),
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context), child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«')),
          ElevatedButton(
            onPressed: () { result = ctrl.text; Navigator.pop(context); }, 
            child: const Text('OK'),
          ),
        ],
      ),
    );
    return result;
  }
}
</file>

<file path="lib/screens/settings_overlay.dart">
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/user_provider.dart';
import '../overlays/global_overlay.dart';

class SettingsOverlay extends StatelessWidget {
  const SettingsOverlay({super.key});

  @override
  Widget build(BuildContext context) {
    final userProv = context.watch<UserProvider>();

    return Material(
      color: Colors.transparent,
      child: Center(
        child: Container(
          width: 320,
          // ç”»é¢ã®é«˜ã•80%ã‚’ä¸Šé™ã¨ã—ã€ãã‚Œä»¥ä¸Šã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹è¨­å®š
          constraints: BoxConstraints(
            maxHeight: MediaQuery.of(context).size.height * 0.8,
          ),
          margin: const EdgeInsets.symmetric(vertical: 20),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(20),
            boxShadow: [
              BoxShadow(
                color: Colors.black26,
                blurRadius: 10,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          // â˜…ä¿®æ­£ç‚¹: ClipRRectã¨SingleChildScrollViewã§ãƒ©ãƒƒãƒ—ã—ã¦Overflowã‚’é˜²æ­¢
          child: ClipRRect(
            borderRadius: BorderRadius.circular(20),
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(24),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      const Text(
                        'è¨­å®š',
                        style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold),
                      ),
                      IconButton(
                        icon: const Icon(Icons.close),
                        onPressed: () => GlobalOverlay().hide(),
                      ),
                    ],
                  ),
                  const Divider(),
                  const SizedBox(height: 16),

                  // ç”»è³ªè¨­å®š
                  const Text('ç”»è³ªè¨­å®š', style: TextStyle(fontWeight: FontWeight.bold)),
                  const SizedBox(height: 8),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                    children: ['ä½', 'ä¸­', 'é«˜'].map((label) {
                      final isSelected = userProv.quality == label;
                      return ChoiceChip(
                        label: Text(label),
                        selected: isSelected,
                        selectedColor: Colors.cyanAccent,
                        onSelected: (selected) {
                          if (selected) {
                            userProv.updateSettings(quality: label);
                          }
                        },
                      );
                    }).toList(),
                  ),

                  const SizedBox(height: 24),

                  // ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š
                  SwitchListTile(
                    contentPadding: EdgeInsets.zero,
                    title: const Text('ã‚µã‚¦ãƒ³ãƒ‰ (BGM/SE)', style: TextStyle(fontWeight: FontWeight.bold)),
                    value: userProv.soundEnabled,
                    activeColor: Colors.cyan,
                    onChanged: (v) => userProv.updateSettings(soundEnabled: v),
                  ),

                  // ãƒœã‚¤ã‚¹ãƒãƒ£ãƒƒãƒˆè¨­å®š
                  SwitchListTile(
                    contentPadding: EdgeInsets.zero,
                    title: const Text('ãƒœã‚¤ã‚¹ãƒãƒ£ãƒƒãƒˆ', style: TextStyle(fontWeight: FontWeight.bold)),
                    value: userProv.vcEnabled,
                    activeColor: Colors.cyan,
                    onChanged: (v) => userProv.updateSettings(vcEnabled: v),
                  ),

                  const SizedBox(height: 24),
                  
                  // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
                  SizedBox(
                    width: double.infinity,
                    height: 50,
                    child: ElevatedButton(
                      onPressed: () => GlobalOverlay().hide(),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.grey.shade200,
                        foregroundColor: Colors.black,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(10),
                        ),
                      ),
                      child: const Text('é–‰ã˜ã‚‹', style: TextStyle(fontSize: 16)),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
</file>

<file path="lib/screens/title_screen.dart">
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../providers/user_provider.dart';
import '../overlays/global_overlay.dart'; // è¨­å®šç”»é¢è¡¨ç¤ºç”¨
import '../screens/settings_overlay.dart'; // è¨­å®šç”»é¢ã®ä¸­èº«

class TitleScreen extends StatefulWidget {
  const TitleScreen({super.key});

  @override
  State<TitleScreen> createState() => _TitleScreenState();
}

class _TitleScreenState extends State<TitleScreen> {
  final TextEditingController _nameController = TextEditingController();

  @override
  void initState() {
    super.initState();
    // ç”»é¢æç”»å¾Œã«ä¿å­˜ã•ã‚ŒãŸåå‰ã‚’ã‚»ãƒƒãƒˆ
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final userProvider = context.read<UserProvider>();
      _nameController.text = userProvider.username;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      // Stackã‚’ä½¿ã£ã¦å³ä¸Šã«è¨­å®šãƒœã‚¿ãƒ³ã‚’é…ç½®ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      body: SafeArea(
        child: Stack(
          children: [
            // --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ---
            Center(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(24.0),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // ã‚¿ã‚¤ãƒˆãƒ«ãƒ­ã‚´
                    const Icon(Icons.directions_run, size: 100, color: Colors.cyan),
                    const SizedBox(height: 20),
                    const Text(
                      'ãƒ–ãƒ­ãƒƒã‚¯ãŠã«',
                      style: TextStyle(fontSize: 40, fontWeight: FontWeight.bold, color: Colors.cyan),
                    ),
                    const SizedBox(height: 40),

                    // åå‰å…¥åŠ›
                    SizedBox(
                      width: 300,
                      child: TextField(
                        controller: _nameController,
                        decoration: const InputDecoration(
                          labelText: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å',
                          border: OutlineInputBorder(),
                          prefixIcon: Icon(Icons.person),
                        ),
                      ),
                    ),
                    const SizedBox(height: 20),

                    // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
                    SizedBox(
                      width: 200,
                      height: 50,
                      child: ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.orangeAccent,
                          foregroundColor: Colors.white,
                        ),
                        onPressed: () async {
                          final name = _nameController.text;
                          if (name.isEmpty) return;

                          // åå‰ã‚’ä¿å­˜
                          final success = await context.read<UserProvider>().saveUsername(name);
                          
                          if (success && mounted) {
                            Navigator.pushNamed(context, '/lobby');
                          }
                        },
                        child: const Text('ã‚¹ã‚¿ãƒ¼ãƒˆ', style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                      ),
                    ),
                  ],
                ),
              ),
            ),

            // --- â˜…è¿½åŠ : è¨­å®šãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šï¼‰ ---
            Positioned(
              top: 10,
              right: 10,
              child: IconButton(
                icon: const Icon(Icons.settings, size: 30, color: Colors.grey),
                onPressed: () {
                  // è¨­å®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
                  GlobalOverlay().show(child: const SettingsOverlay());
                },
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</file>

<file path="lib/services/socket_service.dart">
import 'dart:async';
import 'package:socket_io_client/socket_io_client.dart' as io;

/// è²¬å‹™: Socket.ioã®æ¥ç¶šç®¡ç†ã€ã‚¤ãƒ™ãƒ³ãƒˆé€å—ä¿¡ã®ãƒ©ãƒƒãƒ— [cite: 43-44]
class SocketService {
  // ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¢ãƒ—ãƒªå†…ã§1ã¤ã ã‘ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚‹ï¼‰
  static final SocketService _instance = SocketService._internal();
  factory SocketService() => _instance;
  SocketService._internal();

  io.Socket? _socket;

  /// ã‚½ã‚±ãƒƒãƒˆæ¥ç¶šã®ç¢ºç«‹ [cite: 45]
  void init(String url) {
    _socket = io.io(url, io.OptionBuilder()
      .setTransports(['websocket']) // WebSocketã®ã¿ä½¿ç”¨
      .disableAutoConnect()
      .build());

    _socket?.onConnect((_) => print('Connected to Server'));
    _socket?.onDisconnect((_) => print('Disconnected from Server'));
    _socket?.onConnectError((data) => print('Connect Error: $data'));
    
    _socket?.connect();
  }

  /// ã‚µãƒ¼ãƒãƒ¼ã¸ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ã—ã€å¿œç­”(Ack)ã‚’å¾…æ©Ÿã™ã‚‹ [cite: 45]
  Future<dynamic> emitWithAck(String event, dynamic data) async {
    if (_socket == null || !_socket!.connected) {
      throw Exception('Socket is not connected');
    }

    final completer = Completer<dynamic>();

    // ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡
    _socket!.emitWithAck(event, data, ack: (response) {
      if (!completer.isCompleted) {
        completer.complete(response);
      }
    });

    // 5ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ [cite: 46]
    return completer.future.timeout(
      const Duration(seconds: 5),
      onTimeout: () => throw TimeoutException('Server response timed out: $event'),
    );
  }

  // Ackã‚’å¾…ãŸãªã„é€šå¸¸ã®é€ä¿¡
  void emit(String event, dynamic data) {
    _socket?.emit(event, data);
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²
  void on(String event, Function(dynamic) handler) {
    _socket?.on(event, handler);
  }
}
</file>

<file path="lib/services/unity_bridge_service.dart">
import 'dart:convert';
import 'package:flutter_unity_widget/flutter_unity_widget.dart';

/// è²¬å‹™: Flutter ã¨ Unity é–“ã®ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼é€šä¿¡ã‚’æŠ½è±¡åŒ– [cite: 53-54]
class UnityBridgeService {
  UnityWidgetController? _unityWidgetController;

  // Unityã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãŒç”Ÿæˆã•ã‚ŒãŸã‚‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
  void setController(UnityWidgetController controller) {
    _unityWidgetController = controller;
  }

  /// Flutter -> Unity: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ [cite: 55]
  void sendToUnity(String method, Map<String, dynamic> args) {
    // è¨­è¨ˆæ›¸ã®é€šä¿¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¡ˆã«åŸºã¥ãJSONä½œæˆ [cite: 61-68]
    final String message = jsonEncode({
      "api": "FlutterToUnity",
      "method": method,
      "parameters": args,
    });

    // Unityå´ã® 'UnityReceiverObject' ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® 'OnMessageFromFlutter' ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶
    _unityWidgetController?.postMessage(
      'UnityReceiverObject', 
      'OnMessageFromFlutter',
      message,
    );
  }

  /// Unity -> Flutter: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡å‡¦ç† [cite: 57]
  void onMessageFromUnity(dynamic message) {
    try {
      final Map<String, dynamic> data = jsonDecode(message.toString());
      final String type = data['type'] ?? '';

      // å¿…è¦ã«å¿œã˜ã¦Providerã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™å‡¦ç†ã‚’ã“ã“ã«è¨˜è¿°
      print("Received from Unity: $type");
      
    } catch (e) {
      print("Unity Message Parse Error: $e");
    }
  }
}
</file>

<file path="lib/utils/validators.dart">
class Validators {
  static bool isValidUserName(String name) {
    final trimmed = name.trim();
    if (trimmed.isEmpty) return false;
    if (trimmed.length > 12) return false;

    // çµµæ–‡å­—ã‚’å¼¾ãï¼ˆã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢æ¤œå‡ºï¼‰
    final emojiRegex = RegExp(
      r'[\u{1F300}-\u{1FAFF}]',
      unicode: true,
    );
    if (emojiRegex.hasMatch(trimmed)) return false;

    return true;
  }

  static bool isValidPassword(String password) {
    return password.length >= 4 && password.length <= 8;
  }

  static bool isValidChat(String text) {
    return text.length <= 140;
  }
}
</file>

<file path="unity/My project/Assets/FlutterUnityIntegration/Editor/Build.cs">
using System;
using System.IO;
using System.Linq;
using System.Text.RegularExpressions;
using UnityEditor;
using UnityEditor.Build;
using UnityEngine;
using Application = UnityEngine.Application;
using BuildResult = UnityEditor.Build.Reporting.BuildResult;

// uncomment for addressables
//using UnityEditor.AddressableAssets;
//using UnityEditor.AddressableAssets.Settings;

namespace FlutterUnityIntegration.Editor
{
    public class Build : EditorWindow
    {
        private static readonly string ProjectPath = Path.GetFullPath(Path.Combine(Application.dataPath, ".."));
        private static readonly string APKPath = Path.Combine(ProjectPath, "Builds/" + Application.productName + ".apk");

        private static readonly string AndroidExportPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../android/unityLibrary"));
        private static readonly string WindowsExportPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../windows/unityLibrary/data"));
        private static readonly string IOSExportPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../ios/UnityLibrary"));
        private static readonly string WebExportPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../web/UnityLibrary"));
        private static readonly string IOSExportPluginPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../ios_xcode/UnityLibrary"));

        private bool _pluginMode = false;
        private static string _persistentKey = "flutter-unity-widget-pluginMode";

        //#region GUI Member Methods
        [MenuItem("Flutter/Export Android (Debug) %&n", false, 101)]
        public static void DoBuildAndroidLibraryDebug()
        {
            DoBuildAndroid(Path.Combine(APKPath, "unityLibrary"), false, false);
        }

        [MenuItem("Flutter/Export Android (Release) %&m", false, 102)]
        public static void DoBuildAndroidLibraryRelease()
        {
            DoBuildAndroid(Path.Combine(APKPath, "unityLibrary"), false, true);
        }

        [MenuItem("Flutter/Export Android Plugin %&p", false, 103)]
        public static void DoBuildAndroidPlugin()
        {
            DoBuildAndroid(Path.Combine(APKPath, "unityLibrary"), true, true);
        }

        [MenuItem("Flutter/Export IOS (Debug) %&i", false, 201)]
        public static void DoBuildIOSDebug()
        {
            BuildIOS(IOSExportPath, false);
        }

        [MenuItem("Flutter/Export IOS (Release) %&i", false, 202)]
        public static void DoBuildIOSRelease() {
            BuildIOS(IOSExportPath, true);
        }

        [MenuItem("Flutter/Export IOS Plugin %&o", false, 203)]
        public static void DoBuildIOSPlugin()
        {
            BuildIOS(IOSExportPluginPath, true);

            // Automate so manual steps
            SetupIOSProjectForPlugin();

            // Build Archive
            // BuildUnityFrameworkArchive();

        }

        [MenuItem("Flutter/Export Web GL %&w", false, 301)]
        public static void DoBuildWebGL()
        {
            BuildWebGL(WebExportPath);
        }

      // Hide this button as windows isn't implemented in the Flutter plugin yet.
      //  [MenuItem("Flutter/Export Windows %&d", false, 401)]
        public static void DoBuildWindowsOS()
        {
            BuildWindowsOS(WindowsExportPath);
        }

        [MenuItem("Flutter/Settings %&S", false, 501)]
        public static void PluginSettings()
        {
            EditorWindow.GetWindow(typeof(Build));
        }

        private void OnGUI()
        {
            GUILayout.Label("Flutter Unity Widget Settings", EditorStyles.boldLabel);

            EditorGUI.BeginChangeCheck();
            _pluginMode = EditorGUILayout.Toggle("Plugin Mode", _pluginMode);

            if (EditorGUI.EndChangeCheck())
            {
                EditorPrefs.SetBool(_persistentKey, _pluginMode);
            }
        }

        private void OnEnable()
        {
            _pluginMode = EditorPrefs.GetBool(_persistentKey, false);
        }
        //#endregion


        //#region Build Member Methods

        private static void BuildWindowsOS(String path)
        {
            // Switch to Android standalone build.
            EditorUserBuildSettings.SwitchActiveBuildTarget(BuildTargetGroup.Android, BuildTarget.Android);

            if (Directory.Exists(path))
                Directory.Delete(path, true);

            if (Directory.Exists(WindowsExportPath))
                Directory.Delete(WindowsExportPath, true);

            var playerOptions = new BuildPlayerOptions
            {
                scenes = GetEnabledScenes(),
                target = BuildTarget.StandaloneWindows64,
                locationPathName = path,
                options = BuildOptions.AllowDebugging
            };

            // Switch to Android standalone build.
            EditorUserBuildSettings.SwitchActiveBuildTarget(BuildTargetGroup.Standalone, BuildTarget.StandaloneWindows64);

            // build addressable
            ExportAddressables();
            var report = BuildPipeline.BuildPlayer(playerOptions);

            if (report.summary.result != BuildResult.Succeeded)
                throw new Exception("Build failed");

            Debug.Log("-- Windows Build: SUCCESSFUL --");
        }

        private static void BuildWebGL(String path)
        {
            // Check if the Unity project is in the expected location
            if (!IsProjectLocationValid(path, "web")) {
                return;
            }

            // Switch to Android standalone build.
            EditorUserBuildSettings.SwitchActiveBuildTarget(BuildTargetGroup.Android, BuildTarget.Android);

            if (Directory.Exists(path))
                Directory.Delete(path, true);

            if (Directory.Exists(WebExportPath))
                Directory.Delete(WebExportPath, true);

            // EditorUserBuildSettings. = true;

            var playerOptions = new BuildPlayerOptions();
            playerOptions.scenes = GetEnabledScenes();
            playerOptions.target = BuildTarget.WebGL;
            playerOptions.locationPathName = path;

            // Switch to Android standalone build.
            EditorUserBuildSettings.SwitchActiveBuildTarget(BuildTargetGroup.WebGL, BuildTarget.WebGL);
            // build addressable
            ExportAddressables();
            var report = BuildPipeline.BuildPlayer(playerOptions);

            if (report.summary.result != BuildResult.Succeeded)
                throw new Exception("Build failed");

            // Copy(path, WebExportPath);
            ModifyWebGLExport();

            Debug.Log("-- WebGL Build: SUCCESSFUL --");
        }

        private static void DoBuildAndroid(String buildPath, bool isPlugin, bool isReleaseBuild)
        {
            // Check if the Unity project is in the expected location
            if (!IsProjectLocationValid(AndroidExportPath, "android")) {
                return;
            }

            // Switch to Android standalone build.
            EditorUserBuildSettings.SwitchActiveBuildTarget(BuildTargetGroup.Android, BuildTarget.Android);

            if (Directory.Exists(APKPath))
                Directory.Delete(APKPath, true);

            if (Directory.Exists(AndroidExportPath))
                Directory.Delete(AndroidExportPath, true);

            EditorUserBuildSettings.androidBuildSystem = AndroidBuildSystem.Gradle;
            EditorUserBuildSettings.exportAsGoogleAndroidProject = true;

            var playerOptions = new BuildPlayerOptions();
            playerOptions.scenes = GetEnabledScenes();
            playerOptions.target = BuildTarget.Android;
            playerOptions.locationPathName = APKPath;
            if (!isReleaseBuild)
            {
                // remove this line if you don't use a debugger and you want to speed up the flutter build
                playerOptions.options = BuildOptions.AllowDebugging | BuildOptions.Development;
            }
            #if UNITY_6000_0_OR_NEWER
                PlayerSettings.SetIl2CppCompilerConfiguration(NamedBuildTarget.Android, isReleaseBuild ? Il2CppCompilerConfiguration.Release : Il2CppCompilerConfiguration.Debug);
                PlayerSettings.SetIl2CppCodeGeneration(NamedBuildTarget.Android, isReleaseBuild ? Il2CppCodeGeneration.OptimizeSpeed : Il2CppCodeGeneration.OptimizeSize);
            #elif UNITY_2022_1_OR_NEWER
                PlayerSettings.SetIl2CppCompilerConfiguration(BuildTargetGroup.Android, isReleaseBuild ? Il2CppCompilerConfiguration.Release : Il2CppCompilerConfiguration.Debug);
                PlayerSettings.SetIl2CppCodeGeneration(NamedBuildTarget.Android, isReleaseBuild ? Il2CppCodeGeneration.OptimizeSpeed : Il2CppCodeGeneration.OptimizeSize);
            #elif UNITY_2021_2_OR_NEWER
                PlayerSettings.SetIl2CppCompilerConfiguration(BuildTargetGroup.Android, isReleaseBuild ? Il2CppCompilerConfiguration.Release : Il2CppCompilerConfiguration.Debug);
                EditorUserBuildSettings.il2CppCodeGeneration = isReleaseBuild ? Il2CppCodeGeneration.OptimizeSpeed : Il2CppCodeGeneration.OptimizeSize;
            #endif


#if UNITY_ANDROID && UNITY_6000_0_OR_NEWER
            UnityEditor.Android.UserBuildSettings.DebugSymbols.level = isReleaseBuild ? Unity.Android.Types.DebugSymbolLevel.None : Unity.Android.Types.DebugSymbolLevel.SymbolTable;
            UnityEditor.Android.UserBuildSettings.DebugSymbols.format = Unity.Android.Types.DebugSymbolFormat.LegacyExtensions;
#endif
#if UNITY_ANDROID && UNITY_2023_1_OR_NEWER
            PlayerSettings.Android.applicationEntry = AndroidApplicationEntry.Activity;
#endif
            // Switch to Android standalone build.
            EditorUserBuildSettings.SwitchActiveBuildTarget(BuildTargetGroup.Android, BuildTarget.Android);
            // build addressable
            ExportAddressables();
            var report = BuildPipeline.BuildPlayer(playerOptions);

            if (report.summary.result != BuildResult.Succeeded)
                throw new Exception("Build failed");

            Copy(buildPath, AndroidExportPath);

            // Unity 6000 shared folder
            string sharedPath = Path.Combine(APKPath, "shared");
            if (Directory.Exists(sharedPath)) 
            {
                Copy(sharedPath, Path.Combine(AndroidExportPath, "shared"));
            }

            // Modify build.gradle
            ModifyAndroidGradle(isPlugin);

            if(isPlugin)
            {
                SetupAndroidProjectForPlugin();
            } else
            {
                SetupAndroidProject();
            }

            // Copy over resources from the launcher module that are used by the library, Avoid deleting the existing src/main/res contents.
            Copy(Path.Combine(APKPath + "/launcher/src/main/res"), Path.Combine(AndroidExportPath, "src/main/res"), false);

            if (isReleaseBuild) {
                Debug.Log($"-- Android Release Build: SUCCESSFUL --");
            } else
            {
                Debug.Log($"-- Android Debug Build: SUCCESSFUL --");
            }
        }

        private static void ModifyWebGLExport()
        {
            // Modify index.html
            var indexFile = Path.Combine(WebExportPath, "index.html");
            var indexHtmlText = File.ReadAllText(indexFile);

            indexHtmlText = indexHtmlText.Replace("<script>", @"
    <script>
        var mainUnityInstance;

        window['handleUnityMessage'] = function (params) {
        window.parent.postMessage({
            name: 'onUnityMessage',
            data: params,
            }, '*');
        };

        window['handleUnitySceneLoaded'] = function (name, buildIndex, isLoaded, isValid) {
        window.parent.postMessage({
            name: 'onUnitySceneLoaded',
            data: {
                'name': name,
                'buildIndex': buildIndex,
                'isLoaded': isLoaded == 1,
                'isValid': isValid == 1,
            }
            }, '*');
        };

        window.parent.addEventListener('unityFlutterBiding', function (args) {
            const obj = JSON.parse(args.data);
            mainUnityInstance.SendMessage(obj.gameObject, obj.methodName, obj.message);
        });

        window.parent.addEventListener('unityFlutterBidingFnCal', function (args) {
            mainUnityInstance.SendMessage('GameManager', 'HandleWebFnCall', args.data);
        });
        ");

            indexHtmlText = indexHtmlText.Replace("canvas.style.width = \"960px\";", "canvas.style.width = \"100%\";");
			indexHtmlText = indexHtmlText.Replace("canvas.style.height = \"600px\";", "canvas.style.height = \"100%\";");

			indexHtmlText = indexHtmlText.Replace("}).then((unityInstance) => {", @"
         }).then((unityInstance) => {
           window.parent.postMessage('unityReady', '*');
           mainUnityInstance = unityInstance;
         ");
			File.WriteAllText(indexFile, indexHtmlText);

			/// Modidy style.css
			var cssFile = Path.Combine($"{WebExportPath}/TemplateData", "style.css");
			var fullScreenCss = File.ReadAllText(cssFile);
			fullScreenCss = @"
body { padding: 0; margin: 0; overflow: hidden; }
#unity-container { position: absolute }
#unity-container.unity-desktop { width: 100%; height: 100% }
#unity-container.unity-mobile { width: 100%; height: 100% }
#unity-canvas { background: #231F20 }
.unity-mobile #unity-canvas { width: 100%; height: 100% }
#unity-loading-bar { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: none }
#unity-logo { width: 154px; height: 130px; background: url('unity-logo-dark.png') no-repeat center }
#unity-progress-bar-empty { width: 141px; height: 18px; margin-top: 10px; background: url('progress-bar-empty-dark.png') no-repeat center }
#unity-progress-bar-full { width: 0%; height: 18px; margin-top: 10px; background: url('progress-bar-full-dark.png') no-repeat center }
#unity-footer { display: none }
.unity-mobile #unity-footer { display: none }
#unity-webgl-logo { float:left; width: 204px; height: 38px; background: url('webgl-logo.png') no-repeat center }
#unity-build-title { float: right; margin-right: 10px; line-height: 38px; font-family: arial; font-size: 18px }
#unity-fullscreen-button { float: right; width: 38px; height: 38px; background: url('fullscreen-button.png') no-repeat center }
#unity-mobile-warning { position: absolute; left: 50%; top: 5%; transform: translate(-50%); background: white; padding: 10px; display: none }
            ";
			File.WriteAllText(cssFile, fullScreenCss);
        }

        private static void ModifyAndroidGradle(bool isPlugin)
        {
            // Modify build.gradle
            var buildFile = Path.Combine(AndroidExportPath, "build.gradle");
            var buildText = File.ReadAllText(buildFile);
            buildText = buildText.Replace("com.android.application", "com.android.library");
            buildText = buildText.Replace("bundle {", "splits {");
            buildText = buildText.Replace("enableSplit = false", "enable false");
            buildText = buildText.Replace("enableSplit = true", "enable true");
            buildText = buildText.Replace("implementation fileTree(dir: 'libs', include: ['*.jar'])", "implementation(name: 'unity-classes', ext:'jar')");
            buildText = buildText.Replace(" + unityStreamingAssets.tokenize(', ')", "");
            // disable the Unity ndk path as it will conflict with Flutter.
            buildText = buildText.Replace("ndkPath \"", "// ndkPath \"");

            // Untiy 6000, handle ../shared/
            buildText = Regex.Replace(buildText, @"\.\./shared/", "./shared/");
            

            // check for namespace definition (Android gradle plugin 8+), add a backwards compatible version if it is missing.
            if(!buildText.Contains("namespace")) 
            {
                buildText = buildText.Replace("compileOptions {",
                    "if (project.android.hasProperty(\"namespace\")) {\n        namespace 'com.unity3d.player'\n    }\n\n    compileOptions {"
                );
            }

            if(isPlugin)
            {
                buildText = Regex.Replace(buildText, @"implementation\(name: 'androidx.* ext:'aar'\)", "\n");
            }

            buildText = Regex.Replace(buildText, @"\n.*applicationId '.+'.*\n", "\n");
            File.WriteAllText(buildFile, buildText);

            // Modify AndroidManifest.xml
            var manifestFile = Path.Combine(AndroidExportPath, "src/main/AndroidManifest.xml");
            var manifestText = File.ReadAllText(manifestFile);
            manifestText = Regex.Replace(manifestText, @"<application .*>", "<application>");
            var regex = new Regex(@"<activity.*>(\s|\S)+?</activity>", RegexOptions.Multiline);
            manifestText = regex.Replace(manifestText, "");
            File.WriteAllText(manifestFile, manifestText);

            // Modify proguard-unity.txt
            var proguardFile = Path.Combine(AndroidExportPath, "proguard-unity.txt");
            var proguardText = File.ReadAllText(proguardFile);
	    proguardText = proguardText.Replace("-ignorewarnings", "-keep class com.xraph.plugin.** { *; }\n-keep class com.unity3d.plugin.* { *; }\n-ignorewarnings");
            File.WriteAllText(proguardFile, proguardText);

            // Make sure "game_view_content_description" is in strings.xml
            var stringsFile = Path.Combine(APKPath, "launcher", "src", "main", "res", "values", "strings.xml");
            if(File.Exists(stringsFile))
            {
                var stringsText = File.ReadAllText(stringsFile);
                if(!stringsText.Contains("game_view_content_description"))
                {
                    stringsText = stringsText.Replace("<resources>", "<resources>\n  <string name=\"game_view_content_description\">Game view</string>");
                    File.WriteAllText(stringsFile, stringsText);
                }
            } else
            {
                Debug.LogError("Android res/values/strings.xml file not found during export.");
            }     
        }

        private static void BuildIOS(String path, bool isReleaseBuild)
        {
            // Check if the Unity project is in the expected location
            if (!IsProjectLocationValid(path, "ios")) {
                return;
            }

            bool abortBuild = false;

            // abort iOS export if #UNITY_IOS is false.
            // Even after SwitchActiveBuildTarget() it will still be false as the code isn't recompiled yet.
            // As a workaround, make the user trigger an export again after the switch.

#if !UNITY_IOS
            abortBuild = true;
            if (Application.isBatchMode)
            {
                Debug.LogError("Incorrect iOS buildtarget, use the -buildTarget argument to set iOS");
            }
            else
            {
                bool dialogResult = EditorUtility.DisplayDialog(
                    "Switch build target to iOS?",
                    "Exporting to iOS first requires a build target switch.\nClick 'Export iOS' again after all importing has finished.",
                    "Switch to iOS",
                    "Cancel"
                );
                if (dialogResult)
                {
                    EditorUserBuildSettings.SwitchActiveBuildTarget(BuildTargetGroup.iOS, BuildTarget.iOS);
                }
            } 
#endif
            //don't return within #if !UNITY_IOS as that results in unreachable code warnings.
            if (abortBuild)
                return;

            if (Directory.Exists(path))
                Directory.Delete(path, true);

            #if (UNITY_2021_1_OR_NEWER)
                EditorUserBuildSettings.iOSXcodeBuildConfig = XcodeBuildConfig.Release;
            #else
                EditorUserBuildSettings.iOSBuildConfigType = iOSBuildType.Release;
            #endif

            #if UNITY_6000_0_OR_NEWER
                PlayerSettings.SetIl2CppCompilerConfiguration(NamedBuildTarget.iOS, isReleaseBuild ? Il2CppCompilerConfiguration.Release : Il2CppCompilerConfiguration.Debug);
                PlayerSettings.SetIl2CppCodeGeneration(NamedBuildTarget.iOS, isReleaseBuild ? Il2CppCodeGeneration.OptimizeSpeed : Il2CppCodeGeneration.OptimizeSize);
            #elif UNITY_2022_1_OR_NEWER
                PlayerSettings.SetIl2CppCompilerConfiguration(BuildTargetGroup.iOS, isReleaseBuild ? Il2CppCompilerConfiguration.Release : Il2CppCompilerConfiguration.Debug);
                PlayerSettings.SetIl2CppCodeGeneration(NamedBuildTarget.iOS, isReleaseBuild ? Il2CppCodeGeneration.OptimizeSpeed : Il2CppCodeGeneration.OptimizeSize);
            #elif UNITY_2021_2_OR_NEWER
                PlayerSettings.SetIl2CppCompilerConfiguration(BuildTargetGroup.iOS, isReleaseBuild ? Il2CppCompilerConfiguration.Release : Il2CppCompilerConfiguration.Debug);
                EditorUserBuildSettings.il2CppCodeGeneration = isReleaseBuild ? Il2CppCodeGeneration.OptimizeSpeed : Il2CppCodeGeneration.OptimizeSize;
            #endif

            var playerOptions = new BuildPlayerOptions
            {
                scenes = GetEnabledScenes(),
                target = BuildTarget.iOS,
                locationPathName = path
            };

            if (!isReleaseBuild)
            {
                playerOptions.options = BuildOptions.AllowDebugging | BuildOptions.Development;
            }

            // build addressable
            ExportAddressables();

            var report = BuildPipeline.BuildPlayer(playerOptions);

            if (report.summary.result != BuildResult.Succeeded)
                throw new Exception("Build failed");

            // log an error if this code is skipped. (might happen when buildtarget is switched from code)
            bool postBuildExecuted = false;
#if UNITY_IOS
            XcodePostBuild.PostBuild(BuildTarget.iOS, report.summary.outputPath);
            postBuildExecuted = true;
#endif
            if (postBuildExecuted)
            {
                if (isReleaseBuild)
                {
                    Debug.Log("-- iOS Release Build: SUCCESSFUL --");
                }
                else
                {
                    Debug.Log("-- iOS Debug Build: SUCCESSFUL --");
                }
            } else
            {
                Debug.LogError("iOS export failed. Failed to modify Unity's Xcode project.");
            }
        }

        //#endregion


        //#region Other Member Methods
        private static void Copy(string source, string destinationPath, bool clearDestination = true)
        {
            if (clearDestination && Directory.Exists(destinationPath))
                Directory.Delete(destinationPath, true);

            Directory.CreateDirectory(destinationPath);

            foreach (var dirPath in Directory.GetDirectories(source, "*",
                         SearchOption.AllDirectories))
                Directory.CreateDirectory(dirPath.Replace(source, destinationPath));

            foreach (var newPath in Directory.GetFiles(source, "*.*",
                         SearchOption.AllDirectories))
                File.Copy(newPath, newPath.Replace(source, destinationPath), true);
        }

        private static string[] GetEnabledScenes()
        {
            var scenes = EditorBuildSettings.scenes
                .Where(s => s.enabled)
                .Select(s => s.path)
                .ToArray();

            return scenes;
        }

        // uncomment for addressables
        private static void ExportAddressables() {
            /*
        Debug.Log("Start building player content (Addressables)");
        Debug.Log("BuildAddressablesProcessor.PreExport start");

        AddressableAssetSettings.CleanPlayerContent(
            AddressableAssetSettingsDefaultObject.Settings.ActivePlayerDataBuilder);

        AddressableAssetProfileSettings profileSettings = AddressableAssetSettingsDefaultObject.Settings.profileSettings;
        string profileId = profileSettings.GetProfileId("Default");
        AddressableAssetSettingsDefaultObject.Settings.activeProfileId = profileId;

        AddressableAssetSettings.BuildPlayerContent();
        Debug.Log("BuildAddressablesProcessor.PreExport done");
        */
        }


        /// <summary>
        /// This method tries to autome the build setup required for Android
        /// </summary>
        private static void SetupAndroidProject()
        {
            var androidPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../android"));
            var androidAppPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../android/app"));
            var projBuildPath = Path.Combine(androidPath, "build.gradle");
            var appBuildPath = Path.Combine(androidAppPath, "build.gradle");
            var settingsPath = Path.Combine(androidPath, "settings.gradle");

            // switch to Kotlin DSL gradle if .kts file is detected (Fluter 3.29+ by default)
            if (File.Exists(projBuildPath + ".kts")) {
                SetupAndroidProjectKotlin();
                return;
            }

            var projBuildScript = File.ReadAllText(projBuildPath);
            var settingsScript = File.ReadAllText(settingsPath);
            var appBuildScript = File.ReadAllText(appBuildPath);

            // Sets up the project build.gradle files correctly
            if (!Regex.IsMatch(projBuildScript, @"flatDir[^/]*[^}]*}"))
            {
                var regex = new Regex(@"allprojects \{[^\{]*\{", RegexOptions.Multiline);
                projBuildScript = regex.Replace(projBuildScript, @"
allprojects {
    repositories {
        flatDir {
            dirs ""${project(':unityLibrary').projectDir}/libs""
        }
");
                File.WriteAllText(projBuildPath, projBuildScript);
            }

            // Sets up the project settings.gradle files correctly
            if (!Regex.IsMatch(settingsScript, @"include "":unityLibrary"""))
            {
                settingsScript += @"

include "":unityLibrary""
project("":unityLibrary"").projectDir = file(""./unityLibrary"")
";
                File.WriteAllText(settingsPath, settingsScript);
            }


            // Sets up the project app build.gradle files correctly
            if (!Regex.IsMatch(appBuildScript, @"dependencies \{"))
            {
                appBuildScript += @"
dependencies {
    implementation project(':unityLibrary')
}
";
                File.WriteAllText(appBuildPath, appBuildScript);
            } else
            {
                if (!appBuildScript.Contains(@"implementation project(':unityLibrary')"))
                {
                    var regex = new Regex(@"dependencies \{", RegexOptions.Multiline);
                    appBuildScript = regex.Replace(appBuildScript, @"
dependencies {
    implementation project(':unityLibrary')
");
                    File.WriteAllText(appBuildPath, appBuildScript);
                }
            }
        }


        // Copy of SetupAndroidProject() adapted to Kotlin DLS .gradle.kts. Generated since Flutter 3.29
        private static void SetupAndroidProjectKotlin()
        {
            var androidPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../android"));
            var androidAppPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../android/app"));
            var projBuildPath = Path.Combine(androidPath, "build.gradle.kts");
            var appBuildPath = Path.Combine(androidAppPath, "build.gradle.kts");
            var settingsPath = Path.Combine(androidPath, "settings.gradle.kts");


            var projBuildScript = File.ReadAllText(projBuildPath);
            var settingsScript = File.ReadAllText(settingsPath);
            var appBuildScript = File.ReadAllText(appBuildPath);

            // Sets up the project build.gradle files correctly
            if (!Regex.IsMatch(projBuildScript, @"flatDir[^/]*[^}]*}"))
            {
                var regex = new Regex(@"allprojects \{[^\{]*\{", RegexOptions.Multiline);
                projBuildScript = regex.Replace(projBuildScript, @"
allprojects {
    repositories {
        flatDir {
            dirs(file(""${project("":unityLibrary"").projectDir}/libs""))
        }
");
                File.WriteAllText(projBuildPath, projBuildScript);
            }

            // Sets up the project settings.gradle.kts files correctly
            if (!Regex.IsMatch(settingsScript, @"include\("":unityLibrary""\)"))
            {
                settingsScript += @"

include("":unityLibrary"")
project("":unityLibrary"").projectDir = file(""./unityLibrary"")
";
                File.WriteAllText(settingsPath, settingsScript);
            }


            // Sets up the project app build.gradle.kts files correctly
            if (!Regex.IsMatch(appBuildScript, @"dependencies \{"))
            {
                appBuildScript += @"
dependencies {
    implementation(project("":unityLibrary""))
}
";
                File.WriteAllText(appBuildPath, appBuildScript);
            }
            else
            {
                if (!appBuildScript.Contains(@"implementation(project("":unityLibrary"")"))
                {
                    var regex = new Regex(@"dependencies \{", RegexOptions.Multiline);
                    appBuildScript = regex.Replace(appBuildScript, @"
dependencies {
    implementation(project("":unityLibrary""))
");
                    File.WriteAllText(appBuildPath, appBuildScript);
                }
            }
        }

        /// <summary>
        /// This method tries to autome the build setup required for Android
        /// </summary>
        private static void SetupAndroidProjectForPlugin()
        {
            var androidPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../android"));
            var projBuildPath = Path.Combine(androidPath, "build.gradle");
            var settingsPath = Path.Combine(androidPath, "settings.gradle");

            if (File.Exists(projBuildPath + ".kts")) {
                SetupAndroidProjectForPluginKotlin();
                return;
            }

            var projBuildScript = File.ReadAllText(projBuildPath);
            var settingsScript = File.ReadAllText(settingsPath);

            // Sets up the project build.gradle files correctly
            if (Regex.IsMatch(projBuildScript, @"// BUILD_ADD_UNITY_LIBS"))
            {
                var regex = new Regex(@"// BUILD_ADD_UNITY_LIBS", RegexOptions.Multiline);
                projBuildScript = regex.Replace(projBuildScript, @"
        flatDir {
            dirs ""${project(':unityLibrary').projectDir}/libs""
        }
");
                File.WriteAllText(projBuildPath, projBuildScript);
            }

            // Sets up the project settings.gradle files correctly
            if (!Regex.IsMatch(settingsScript, @"include "":unityLibrary"""))
            {
                settingsScript += @"

include "":unityLibrary""
project("":unityLibrary"").projectDir = file(""./unityLibrary"")
";
                File.WriteAllText(settingsPath, settingsScript);
            }
        }

        // Copy of SetupAndroidProjectForPlugin() adapted to Kotlin DLS .gradle.kts. Generated since Flutter 3.29
        private static void SetupAndroidProjectForPluginKotlin()
        {
            var androidPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../android"));
            var projBuildPath = Path.Combine(androidPath, "build.gradle.kts");
            var settingsPath = Path.Combine(androidPath, "settings.gradle.kts");

            var projBuildScript = File.ReadAllText(projBuildPath);
            var settingsScript = File.ReadAllText(settingsPath);

            // Sets up the project build.gradle files correctly
            if (Regex.IsMatch(projBuildScript, @"// BUILD_ADD_UNITY_LIBS"))
            {
                var regex = new Regex(@"// BUILD_ADD_UNITY_LIBS", RegexOptions.Multiline);
                projBuildScript = regex.Replace(projBuildScript, @"
        flatDir {
            dirs(file(""${project("":unityLibrary"").projectDir}/libs""))
        }
");
                File.WriteAllText(projBuildPath, projBuildScript);
            }

            // Sets up the project settings.gradle files correctly
            if (!Regex.IsMatch(settingsScript, @"include("":unityLibrary"")"))
            {
                settingsScript += @"

include("":unityLibrary"")
project("":unityLibrary"").projectDir = file(""./unityLibrary"")
";
                File.WriteAllText(settingsPath, settingsScript);
            }
        }

        private static void SetupIOSProjectForPlugin()
        {
            var iosRunnerPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../ios"));
            var pubsecFile = Path.Combine(iosRunnerPath, "flutter_unity_widget.podspec");
            var pubsecText = File.ReadAllText(pubsecFile);

            if (!Regex.IsMatch(pubsecText, @"\w\.xcconfig(?:[^}]*})+") && !Regex.IsMatch(pubsecText, @"tar -xvjf UnityFramework.tar.bz2"))
            {
                var regex = new Regex(@"\w\.xcconfig(?:[^}]*})+", RegexOptions.Multiline);
                pubsecText = regex.Replace(pubsecText, @"
	spec.xcconfig = {
        'FRAMEWORK_SEARCH_PATHS' => '""${PODS_ROOT}/../.symlinks/plugins/flutter_unity_widget/ios"" ""${PODS_ROOT}/../.symlinks/flutter/ios-release"" ""${PODS_CONFIGURATION_BUILD_DIR}""',
        'OTHER_LDFLAGS' => '$(inherited) -framework UnityFramework \${PODS_LIBRARIES}'
    }

    spec.vendored_frameworks = ""UnityFramework.framework""
			");
                File.WriteAllText(pubsecFile, pubsecText);
            }
        }

        // DO NOT USE (Contact before trying)
        private static async void BuildUnityFrameworkArchive()
        {
            var xcprojectExt = "/Unity-iPhone.xcodeproj";

            // check if we have a workspace or not
            if (Directory.Exists(IOSExportPluginPath + "/Unity-iPhone.xcworkspace")) {
                xcprojectExt = "/Unity-iPhone.xcworkspace";
            }

            const string framework = "UnityFramework";
            var xcprojectName = $"{IOSExportPluginPath}{xcprojectExt}";
            var schemeName = $"{framework}";
            var buildPath = IOSExportPluginPath + "/build";
            var frameworkNameWithExt = $"{framework}.framework";

            var iosRunnerPath = Path.GetFullPath(Path.Combine(ProjectPath, "../../ios/"));
            const string iosArchiveDir = "Release-iphoneos-archive";
            var iosArchiveFrameworkPath = $"{buildPath}/{iosArchiveDir}/Products/Library/Frameworks/{frameworkNameWithExt}";
            var dysmNameWithExt = $"{frameworkNameWithExt}.dSYM";

            try
            {
                Debug.Log("### Cleaning up after old builds");
                await $" - rf {iosRunnerPath}{frameworkNameWithExt}".Bash("rm");
                await $" - rf {buildPath}".Bash("rm");

                Debug.Log("### BUILDING FOR iOS");
                Debug.Log("### Building for device (Archive)");

                await $"archive -workspace {xcprojectName} -scheme {schemeName} -sdk iphoneos -archivePath {buildPath}/Release-iphoneos.xcarchive ENABLE_BITCODE=NO |xcpretty".Bash("xcodebuild");

                Debug.Log("### Copying framework files");
                await $" -RL {iosArchiveFrameworkPath} {iosRunnerPath}/{frameworkNameWithExt}".Bash("cp");
                await $" -RL {iosArchiveFrameworkPath}/{dysmNameWithExt} {iosRunnerPath}/{dysmNameWithExt}".Bash("cp");
                Debug.Log("### DONE ARCHIVING");
            }
            catch (Exception e)
            {
                Debug.Log(e);
            }


        }


        // check if the Unity project is in the expected location
        private static bool IsProjectLocationValid(string unityLibraryPath, string platform)
        { 
            // android, ios and web use platform/unityLibrary, move up one step.
            string platformPath = Path.Combine(unityLibraryPath, "../");
            if (!Directory.Exists(platformPath))
            {
                Debug.LogError($"Could not find the Flutter project {platform} folder. Make sure the Unity project folder is located in '<flutter-project>/unity/<unity-project-folder>' .");
                Debug.Log($"-- Build: Failed --");
                return false;
            }
            return true;
        }

        //#endregion
    }
}
</file>

<file path="unity/My project/Assets/FlutterUnityIntegration/Editor/SweetShellHelper.cs">
using System.Diagnostics;
using System.Threading.Tasks;
using System;

public static class SweetShellHelper
{
    public static Task<int> Bash(this string cmd, string fileName)
    {
        var source = new TaskCompletionSource<int>();
        var escapedArgs = cmd.Replace("\"", "\\\"");
        var process = new Process
        {
            StartInfo = new ProcessStartInfo
            {
                FileName = fileName,
                Arguments = $"\"{escapedArgs}\"",
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                UseShellExecute = false,
                CreateNoWindow = true
            },
            EnableRaisingEvents = true
        };
        process.Exited += (sender, args) =>
        {
            UnityEngine.Debug.LogWarning(process.StandardError.ReadToEnd());
            UnityEngine.Debug.Log(process.StandardOutput.ReadToEnd());
            if (process.ExitCode == 0)
            {
                source.SetResult(0);
            }
            else
            {
                source.SetException(new Exception($"Command `{cmd}` failed with exit code `{process.ExitCode}`"));
            }

            process.Dispose();
        };

        try
        {
            process.Start();
        }
        catch (Exception e)
        {
            UnityEngine.Debug.LogError(e);
            source.SetException(e);
        }

        return source.Task;
    }
}
</file>

<file path="unity/My project/Assets/FlutterUnityIntegration/Editor/XCodePostBuild.cs">
/*
MIT License
Copyright (c) 2021 REX ISAAC RAPHAEL
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

#if UNITY_IOS

using System;

using System.Collections.Generic;
using System.IO;
using System.Text.RegularExpressions;

using UnityEditor;
using UnityEditor.iOS.Xcode;

/// <summary>
/// Adding this post build script to Unity project enables the flutter-unity-widget to access it
/// </summary>
public static class XcodePostBuild
{

    /// <summary>
    /// The identifier added to touched file to avoid double edits when building to existing directory without
    /// replace existing content.
    /// </summary>
    private const string TouchedMarker = "https://github.com/juicycleff/flutter-unity-view-widget";

    // String used to detect where to inject function definitions in UnityAppController.h
#if UNITY_6000_0_OR_NEWER
    private const string hDetection = "#import <UnityFramework/RenderPluginDelegate.h>";
#else
    private const string hDetection = "include \"RenderPluginDelegate.h\"";
#endif

    //trigger this manually from build.cs as [PostProcessBuild] or IPostprocessBuildWithReport don't always seem to trigger.
    public static void PostBuild(BuildTarget target, string pathToBuiltProject)
    {
        if (target != BuildTarget.iOS)
        {
            return;
        }

        PatchUnityNativeCode(pathToBuiltProject);

        UpdateUnityProjectFiles(pathToBuiltProject);

        UpdateBuildSettings(pathToBuiltProject);
    }

    /// <summary>
    /// We need to set particular build settings on the UnityFramework target.
    /// This includes:
    ///   - skip_install = NO (It is YES by default)
    /// </summary>
    /// <param name="pathToBuildProject"></param>
    private static void UpdateBuildSettings(string pathToBuildProject)
    {
        var pbx = new PBXProject();
        var pbxPath = Path.Combine(pathToBuildProject, "Unity-iPhone.xcodeproj/project.pbxproj");
        pbx.ReadFromFile(pbxPath);

        var targetGuid = pbx.GetUnityFrameworkTargetGuid();
        var projGuid = pbx.ProjectGuid();

        // TODO: Rex optional set this value
        // Set skip_install to NO
        pbx.SetBuildProperty(targetGuid, "SKIP_INSTALL", "YES");

        // Set some linker flags
        pbx.SetBuildProperty(projGuid, "ENABLE_BITCODE", "NO");

        // Persist changes
        pbx.WriteToFile(pbxPath);
    }

    /// <summary>
    /// We need to add the Data folder to the UnityFramework framework
    /// </summary>
    private static void UpdateUnityProjectFiles(string pathToBuiltProject)
    {
        var pbx = new PBXProject();
        var pbxPath = Path.Combine(pathToBuiltProject, "Unity-iPhone.xcodeproj/project.pbxproj");
        pbx.ReadFromFile(pbxPath);

        // PatchRemoveTargetMembership(pathToBuiltProject);
        // Add unityLibrary/Data
        var targetGuid = pbx.TargetGuidByName("UnityFramework");
        var fileGuid = pbx.AddFolderReference(Path.Combine(pathToBuiltProject, "Data"), "Data");
        pbx.AddFileToBuild(targetGuid, fileGuid);

        pbx.WriteToFile(pbxPath);
    }

    /// <summary>
    /// Make necessary changes to Unity build output that enables it to be embedded into existing Xcode project.
    /// </summary>
    private static void PatchUnityNativeCode(string pathToBuiltProject)
    {
        if (!CheckUnityAppController(Path.Combine(pathToBuiltProject, "Classes/UnityAppController.h")))
        {
            EditUnityAppControllerH(Path.Combine(pathToBuiltProject, "Classes/UnityAppController.h"));
            MarkUnityAppControllerH(Path.Combine(pathToBuiltProject, "Classes/UnityAppController.h"));
        }

        if (!CheckUnityAppController(Path.Combine(pathToBuiltProject, "Classes/UnityAppController.mm")))
        {
            EditUnityAppControllerMM(Path.Combine(pathToBuiltProject, "Classes/UnityAppController.mm"));
            MarkUnityAppControllerMM(Path.Combine(pathToBuiltProject, "Classes/UnityAppController.mm"));
        }
    }

    private static bool MarkUnityAppControllerH(string path)
    {
        var inScope = false;
        var mark = false;
        EditCodeFile(path, line =>
        {
            inScope |= line.Contains(hDetection);
            if (inScope)
            {
                if (line.Trim() == "")
                {
                    inScope = false;

                    return new string[]
                    {
                        "",
                        "// Edited by " + TouchedMarker,
                        "",
                    };
                }

                return new string[] { line };
            }

            return new string[] { line };
        });
        return mark;
    }

    private static bool MarkUnityAppControllerMM(string path)
    {
        var inScope = false;
        var mark = false;
        EditCodeFile(path, line =>
        {
            inScope |= line.Contains("#include <sys/sysctl.h>");
            if (inScope)
            {
                if (line.Trim() == "")
                {
                    inScope = false;

                    return new string[]
                    {
                        "",
                        "// Edited by " + TouchedMarker,
                        "",
                    };
                }

                return new string[] { line };
            }

            return new string[] { line };
        });
        return mark;
    }
    private static bool CheckUnityAppController(string path)
    {
        var mark = false;
        EditCodeFile(path, line =>
        {
            mark |= line.Contains("// Edited by " + TouchedMarker);
            return new string[] { line };
        });
        return mark;
    }

    /// <summary>
    /// Edit 'UnityAppController.h': returns 'UnityAppController' from 'AppDelegate' class.
    /// </summary>
    private static void EditUnityAppControllerH(string path)
    {
        var inScope = false;
        var markerDetected = false;

        // Modify inline GetAppController
        EditCodeFile(path, line =>
        {
            inScope |= line.Contains(hDetection);

            if (inScope && !markerDetected)
            {
                if (line.Trim() == "")
                {
                    inScope = false;
                    markerDetected = true;

                    return new string[]
                    {
                        "",
                        "// Added by " + TouchedMarker,
                        "@protocol UnityEventListener <NSObject>",
                        "- (void)onSceneLoaded:(NSString *)name buildIndex:(NSInteger *)bIndex loaded:(bool *)isLoaded valid:(bool *)IsValid;",
                        "- (void)onMessage:(NSString *)message;",
                        "@end",
                        "",
                    };
                }

                return new string[] { line };
            }

            return new string[] { line };
        });

        inScope = false;
        markerDetected = false;

        // Modify inline GetAppController
        EditCodeFile(path, line =>
        {
            inScope |= line.Contains(hDetection);

            if (inScope && !markerDetected)
            {
                if (line.Trim() == "")
                {
                    inScope = false;
                    markerDetected = true;

                    return new string[]
                    {
                        "",
                        "// Added by " + TouchedMarker,
                        "typedef void(^unitySceneLoadedCallbackType)(const char* name, const int* buildIndex, const bool* isLoaded, const bool* IsValid);",
                        "",
                        "typedef void(^unityMessageCallbackType)(const char* message);",
                        "",
                    };
                }

                return new string[] { line };
            }

            return new string[] { line };
        });

        inScope = false;
        markerDetected = false;

        // Modify inline GetAppController
        EditCodeFile(path, line =>
        {
            inScope |= line.Contains("quitHandler)");

            if (inScope && !markerDetected)
            {
                if (line.Trim() == "")
                {
                    inScope = false;
                    markerDetected = true;

                    return new string[]
                    {
                        "@property (nonatomic, copy)                                 void(^unitySceneLoadedHandler)(const char* name, const int* buildIndex, const bool* isLoaded, const bool* IsValid);",
                        "@property (nonatomic, copy)                                 void(^unityMessageHandler)(const char* message);",
                    };
                }

                return new string[] { line };
            }

            return new string[] { line };
        });

    }

    /// <summary>
    /// Edit 'UnityAppController.mm': triggers 'UnityReady' notification after Unity is actually started.
    /// </summary>
    private static void EditUnityAppControllerMM(string path)
    {

        var inScope = false;
        var markerDetected = false;

        EditCodeFile(path, line =>
        {
            if (line.Trim() == "@end")
            {
                return new string[]
                {
                    "",
                    "// Added by " + TouchedMarker,
                    "extern \"C\" void OnUnityMessage(const char* message)",
                    "{",
                    "    if (GetAppController().unityMessageHandler) {",
                    "        GetAppController().unityMessageHandler(message);",
                    "    }",
                    "}",
                    "",
                    "extern \"C\" void OnUnitySceneLoaded(const char* name, const int* buildIndex, const bool* isLoaded, const bool* IsValid)",
                    "{",
                    "    if (GetAppController().unitySceneLoadedHandler) {",
                    "        GetAppController().unitySceneLoadedHandler(name, buildIndex, isLoaded, IsValid);",
                    "    }",
                    "}",
                    line,

                };
            }

            inScope |= line.Contains("- (void)startUnity:");
            markerDetected |= inScope && line.Contains(TouchedMarker);

            //Find the end of the startUnity function, a } without any indentation.  (regex: starts with } followed by any whitespace)
            //Avoid indentation before } as newer unity versions include an if-statement inside this function.
            if (inScope && Regex.Match(line, @"^}(\s)*$").Success)
            {
                inScope = false;

                if (markerDetected)
                {
                    return new string[] { line };
                }
                else
                {
                    //Add a UnityReady notification at the end of the startUnity function.
                    return new string[]
                    {
                        "    // Modified by " + TouchedMarker,
                        @"    [[NSNotificationCenter defaultCenter] postNotificationName: @""UnityReady"" object:self];",
                        "}",
                    };
                }
            }

            return new string[] { line };
        });

    }


    private static void EditCodeFile(string path, Func<string, IEnumerable<string>> lineHandler)
    {
        var bakPath = path + ".bak";
        if (File.Exists(bakPath))
        {
            File.Delete(bakPath);
        }

        File.Move(path, bakPath);

        using (var reader = File.OpenText(bakPath))
        using (var stream = File.Create(path))
        using (var writer = new StreamWriter(stream))
        {
            string line;
            while ((line = reader.ReadLine()) != null)
            {
                var outputs = lineHandler(line);
                foreach (var o in outputs)
                {
                    writer.WriteLine(o);
                }
            }
        }
    }
}

#endif
</file>

<file path="unity/My project/Assets/FlutterUnityIntegration/NativeAPI.cs">
using System;
using System.Runtime.InteropServices;
using UnityEngine;
using UnityEngine.SceneManagement;

namespace FlutterUnityIntegration
{
    public class NativeAPI
    {
#if UNITY_IOS && !UNITY_EDITOR
    [DllImport("__Internal")]
    public static extern void OnUnityMessage(string message);

    [DllImport("__Internal")]
    public static extern void OnUnitySceneLoaded(string name, int buildIndex, bool isLoaded, bool IsValid);
#endif

#if UNITY_WEBGL
        [DllImport("__Internal")]
        public static extern void OnUnityMessageWeb(string message);

        [DllImport("__Internal")]
        public static extern void OnUnitySceneLoadedWeb(string name, int buildIndex, bool isLoaded, bool isValid);
#endif

        public static void OnSceneLoaded(Scene scene, LoadSceneMode mode)
        {
#if UNITY_ANDROID
        try
        {
            AndroidJavaClass jc = new AndroidJavaClass("com.xraph.plugin.flutter_unity_widget.UnityPlayerUtils");
            jc.CallStatic("onUnitySceneLoaded", scene.name, scene.buildIndex, scene.isLoaded, scene.IsValid());
        }
        catch (Exception e)
        {
            Debug.Log(e.Message);
        }
#elif UNITY_WEBGL
            OnUnitySceneLoadedWeb(scene.name, scene.buildIndex, scene.isLoaded, scene.IsValid());
#elif UNITY_IOS && !UNITY_EDITOR
        OnUnitySceneLoaded(scene.name, scene.buildIndex, scene.isLoaded, scene.IsValid());
#endif
        }

        public static void SendMessageToFlutter(string message)
        {
#if UNITY_ANDROID
        try
        {
            AndroidJavaClass jc = new AndroidJavaClass("com.xraph.plugin.flutter_unity_widget.UnityPlayerUtils");
            jc.CallStatic("onUnityMessage", message);
        }
        catch (Exception e)
        {
            Debug.Log(e.Message);
        }
#elif UNITY_WEBGL
        OnUnityMessageWeb(message);
#elif UNITY_IOS && !UNITY_EDITOR
        OnUnityMessage(message);
#endif
        }

        public static void ShowHostMainWindow()
        {
#if UNITY_ANDROID
        try
        {
            var jc = new AndroidJavaClass("com.xraph.plugin.flutter_unity_widget.OverrideUnityActivity");
            var overrideActivity = jc.GetStatic<AndroidJavaObject>("instance");
            overrideActivity.Call("showMainActivity");
        }
        catch (Exception e)
        {
            Debug.Log(e.Message);
        }
#elif UNITY_IOS && !UNITY_EDITOR
        // NativeAPI.showHostMainWindow();
#endif
        }

        public static void UnloadMainWindow()
        {
#if UNITY_ANDROID
        try
        {
            AndroidJavaClass jc = new AndroidJavaClass("com.xraph.plugin.flutter_unity_widget.OverrideUnityActivity");
            AndroidJavaObject overrideActivity = jc.GetStatic<AndroidJavaObject>("instance");
            overrideActivity.Call("unloadPlayer");
        }
        catch (Exception e)
        {
            Debug.Log(e.Message);
        }
#elif UNITY_IOS && !UNITY_EDITOR
        // NativeAPI.unloadPlayer();
#endif
        }

        public static void QuitUnityWindow()
        {
#if UNITY_ANDROID
        try
        {
            AndroidJavaClass jc = new AndroidJavaClass("com.xraph.plugin.flutter_unity_widget.OverrideUnityActivity");
            AndroidJavaObject overrideActivity = jc.GetStatic<AndroidJavaObject>("instance");
            overrideActivity.Call("quitPlayer");
        }
        catch (Exception e)
        {
            Debug.Log(e.Message);
        }
#elif UNITY_IOS && !UNITY_EDITOR
        // NativeAPI.quitPlayer();
#endif
        }
    }
}
</file>

<file path="unity/My project/Assets/FlutterUnityIntegration/SingletonMonoBehaviour.cs">
using System;
using UnityEngine;

namespace FlutterUnityIntegration
{
    public abstract class SingletonMonoBehaviour<T> : MonoBehaviour where T : MonoBehaviour
    {
        private static readonly Lazy<T> LazyInstance = new Lazy<T>(CreateSingleton);

        public static T Instance => LazyInstance.Value;

        private static T CreateSingleton()
        {
            var ownerObject = new GameObject($"{typeof(T).Name} (singleton)");
            var instance = ownerObject.AddComponent<T>();
            DontDestroyOnLoad(ownerObject);
            return instance;
        }
    }
}
</file>

<file path="unity/My project/Assets/FlutterUnityIntegration/UnityMessageManager.cs">
using System;
using System.Collections.Generic;
using Newtonsoft.Json.Linq;
using UnityEngine;
using UnityEngine.SceneManagement;

namespace FlutterUnityIntegration
{
    public class MessageHandler
    {
        public int id;
        public string seq;

        public String name;
        private readonly JToken data;

        public static MessageHandler Deserialize(string message)
        {
            var m = JObject.Parse(message);
            var handler = new MessageHandler(
                m.GetValue("id").Value<int>(),
                m.GetValue("seq").Value<string>(),
                m.GetValue("name").Value<string>(),
                m.GetValue("data")
            );
            return handler;
        }

        public T getData<T>()
        {
            return data.Value<T>();
        }

        public MessageHandler(int id, string seq, string name, JToken data)
        {
            this.id = id;
            this.seq = seq;
            this.name = name;
            this.data = data;
        }

        public void send(object data)
        {
            var o = JObject.FromObject(new
            {
                id = id,
                seq = "end",
                name = name,
                data = data
            });
            UnityMessageManager.Instance.SendMessageToFlutter(UnityMessageManager.MessagePrefix + o.ToString());
        }
    }

    public class UnityMessage
    {
        public String name;
        public JObject data;
        public Action<object> callBack;
    }

    public class UnityMessageManager : SingletonMonoBehaviour<UnityMessageManager>
    {

        public const string MessagePrefix = "@UnityMessage@";
        private static int ID = 0;

        private static int generateId()
        {
            ID = ID + 1;
            return ID;
        }

        public delegate void MessageDelegate(string message);
        public event MessageDelegate OnMessage;

        public delegate void MessageHandlerDelegate(MessageHandler handler);
        public event MessageHandlerDelegate OnFlutterMessage;

        private readonly Dictionary<int, UnityMessage> waitCallbackMessageMap = new Dictionary<int, UnityMessage>();

        private void Start()
        {
            SceneManager.sceneLoaded += OnSceneLoaded;
        }

        void OnSceneLoaded(Scene scene, LoadSceneMode mode)
        {
            NativeAPI.OnSceneLoaded(scene, mode);

        }

        public void ShowHostMainWindow()
        {
            NativeAPI.ShowHostMainWindow();
        }

        public void UnloadMainWindow()
        {
            NativeAPI.UnloadMainWindow();
        }


        public void QuitUnityWindow()
        {
            NativeAPI.QuitUnityWindow();
        }


        public void SendMessageToFlutter(string message)
        {
            NativeAPI.SendMessageToFlutter(message);
        }

        public void SendMessageToFlutter(UnityMessage message)
        {
            var id = generateId();
            if (message.callBack != null)
            {
                waitCallbackMessageMap.Add(id, message);
            }

            var o = JObject.FromObject(new
            {
                id = id,
                seq = message.callBack != null ? "start" : "",
                name = message.name,
                data = message.data
            });
            UnityMessageManager.Instance.SendMessageToFlutter(MessagePrefix + o.ToString());
        }

        void onMessage(string message)
        {
            OnMessage?.Invoke(message);
        }

        void onFlutterMessage(string message)
        {
            if (message.StartsWith(MessagePrefix))
            {
                message = message.Replace(MessagePrefix, "");
            }
            else
            {
                return;
            }

            var handler = MessageHandler.Deserialize(message);
            if ("end".Equals(handler.seq))
            {
                // handle callback message
                if (!waitCallbackMessageMap.TryGetValue(handler.id, out var m)) return;
                waitCallbackMessageMap.Remove(handler.id);
                m.callBack?.Invoke(handler.getData<object>()); // todo
                return;
            }

            OnFlutterMessage?.Invoke(handler);
        }
    }
}
</file>

<file path="unity/My project/Assets/Scripts/Common/Models.cs">
using System.Collections.Generic;
using UnityEngine;
using Newtonsoft.Json;

namespace BlockOni.Models
{
    // ã‚µãƒ¼ãƒãƒ¼ã¨ã‚„ã‚Šå–ã‚Šã™ã‚‹JSONãƒ‡ãƒ¼ã‚¿ã®å‹å®šç¾©
    [System.Serializable]
    public class RoomData
    {
        public string id;
        public string status; // "waiting", "playing"
        public List<PlayerData> members;
    }

    [System.Serializable]
    public class PlayerData
    {
        public string id;
        public string name;
        public string role; // "Oni", "Runner"
        public string currentSquareId; // ç¾åœ¨ã®ãƒã‚¹ã®ID (ä¾‹: "Top_2_2")
        public int positionIndex;
    }

    [System.Serializable]
    public class DiceResult
    {
        public string playerId;
        public int result; // 1~6
    }

    [System.Serializable]
    public class MoveResult
    {
        public string playerId;
        public string targetSquareId;
    }
}
</file>

<file path="unity/My project/Assets/Scripts/utils/ArrowSelector.cs">
using UnityEngine;
using System;
using DG.Tweening;

public class ArrowSelector : MonoBehaviour
{
    private string targetSquareId;
    private Action<string> onClickAction;

    public void Setup(string targetId, Vector3 direction, Action<string> onClick)
    {
        this.targetSquareId = targetId;
        this.onClickAction = onClick;

        // è¦‹ãŸç›®: é€²è¡Œæ–¹å‘ã‚’å‘ã
        transform.forward = direction;
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ãµã‚ãµã‚å‹•ã
        transform.DOMove(transform.position + direction * 0.3f, 0.6f)
            .SetLoops(-1, LoopType.Yoyo)
            .SetEase(Ease.InOutSine);
    }

    void OnMouseDown()
    {
        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ç™»éŒ²ã•ã‚ŒãŸå‡¦ç†ã‚’å®Ÿè¡Œ
        onClickAction?.Invoke(targetSquareId);
    }
}
</file>

<file path="unity/My project/Assets/Scripts/utils/Billboard.cs">
using UnityEngine;

public class Billboard : MonoBehaviour
{
    void LateUpdate()
    {
        // ã‚«ãƒ¡ãƒ©ã®æ–¹å‘ã‚’å‘ãï¼ˆåè»¢ã—ãªã„ã‚ˆã†ã«forwardã‚’åˆã‚ã›ã‚‹ï¼‰
        if (Camera.main != null)
        {
            transform.forward = Camera.main.transform.forward;
        }
    }
}
</file>

<file path="pubspec.yaml">
name: block_oni_app
description: "Block Oni - Flutter Ã— Unity Board Game"
publish_to: 'none'

version: 1.0.0+1

environment:
  sdk: ">=3.4.0 <4.0.0"

dependencies:
  flutter:
    sdk: flutter

  # =========================
  # çŠ¶æ…‹ç®¡ç†
  # =========================
  provider: ^6.1.2

  # =========================
  # æ°¸ç¶šåŒ–
  # =========================
  shared_preferences: ^2.2.2

  # =========================
  # Socketé€šä¿¡
  # =========================
  socket_io_client: ^2.0.3+1

  # =========================
  # Unityé€£æºï¼ˆDesktop / Android / iOSï¼‰
  # â€» Webéå¯¾å¿œ
  # =========================
  flutter_unity_widget:
    git:
      url: https://github.com/juicycleff/flutter-unity-view-widget.git
      ref: master

  # UI Icons
  cupertino_icons: ^1.0.8

dev_dependencies:
  flutter_test:
    sdk: flutter

  flutter_lints: ^6.0.0

flutter:
  uses-material-design: true
</file>

<file path="unity/My project/Assets/Scripts/Game/CameraController.cs">
using UnityEngine;

public class CameraController : MonoBehaviour
{
    [Header("ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ")]
    public Transform target; // MapPivot

    [Header("è¨­å®š")]
    public float distance = 15.0f;   // å…¨ä½“ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«å°‘ã—å¼•ã
    public float rotateSpeed = 5.0f; 
    public float minVerticalAngle = -10f; 
    public float maxVerticalAngle = 80f;  

    [Header("ä½ç½®èª¿æ•´")]
    // â˜…ã“ã“ãŒé‡è¦: ä¸­å¿ƒã‚’Yæ–¹å‘ã«ãšã‚‰ã™è¨­å®š
    public Vector3 focusOffset = new Vector3(0, 2.5f, 0); 

    private float currentX = 0f;
    private float currentY = 30f; 

    void Start()
    {
        Vector3 angles = transform.eulerAngles;
        currentX = angles.y;
        currentY = angles.x;
    }

    public void SetTarget(Transform newTarget)
    {
        target = newTarget;
    }

    void Update()
    {
        if (Input.GetMouseButton(0))
        {
            currentX += Input.GetAxis("Mouse X") * rotateSpeed;
            currentY -= Input.GetAxis("Mouse Y") * rotateSpeed;
            currentY = Mathf.Clamp(currentY, minVerticalAngle, maxVerticalAngle);
        }
    }

    void LateUpdate()
    {
        Vector3 targetPos = (target != null) ? target.position : Vector3.zero;

        // â˜…ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä½ç½®ã«ãšã‚‰ã—é‡ã‚’è¶³ã™
        Vector3 finalTargetPos = targetPos + focusOffset;

        Quaternion rotation = Quaternion.Euler(currentY, currentX, 0);
        Vector3 negDistance = new Vector3(0.0f, 0.0f, -distance);
        
        Vector3 position = rotation * negDistance + finalTargetPos;

        transform.rotation = rotation;
        transform.position = position;
    }

    // â˜…ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½: ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¦ã„ã‚‹å ´æ‰€ã‚’èµ¤ã„ç‰ã§è¡¨ç¤º
    void OnDrawGizmos()
    {
        if (target != null)
        {
            Gizmos.color = Color.red;
            // ç¾åœ¨ã®æ³¨è¦–ç‚¹ã‚’æç”»
            Gizmos.DrawSphere(target.position + focusOffset, 0.5f);
        }
    }
}
</file>

<file path="lib/models/game_data.dart">
// Unityã¨åˆã‚ã›ã‚‹ãŸã‚ Vector2Int ã‚’å»ƒæ­¢ã—ã€IDæ–‡å­—åˆ—ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´
class Player {
  final String playerId;
  final String role; // "Oni" or "Runner"
  
  // Unityã®ãƒã‚¹ID (ä¾‹: "Top_2_2")
  String currentSquareId = "";
  
  bool hasActedThisTurn = false;
  Map<String, int> inventory = {};
  
  // ã‚¢ã‚¤ãƒ†ãƒ åŠ¹æœãªã©ã§ä½¿ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  int diceBonus = 0;

  Player({
    required this.playerId,
    required this.role,
    this.currentSquareId = "",
  });

  // JSONãªã©ã‹ã‚‰ç”Ÿæˆã™ã‚‹å ´åˆã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªãªã©ãŒã‚ã‚Œã°ã“ã“ã«è¿½åŠ 
}

class ItemDefinition {
  final String itemId;
  final String itemName;
  final String effectType; // "Teleport", "StageRotate", etc.
  final bool isUsableByRunner;
  final int maxStack = 5;

  ItemDefinition({
    required this.itemId,
    required this.itemName,
    required this.effectType,
    required this.isUsableByRunner
  });
}
</file>

<file path="lib/models/item.dart">
// åŠ¹æœç¨®åˆ¥ã®å®šç¾©
enum ItemEffectType {
  AddDiceValue,      // ãƒ€ã‚¤ã‚¹ç›®åŠ ç®—
  BlockCell,         // ãƒã‚¹é€šè¡Œä¸å¯
  DiceFixed,         // ãƒ€ã‚¤ã‚¹ç›®å›ºå®š
  DiceRange,         // ãƒ€ã‚¤ã‚¹ç›®ç¯„å›²å›ºå®š
  MovementOverride,  // é¬¼ã®ç§»å‹•åˆ¶é™è§£é™¤
  Teleport,          // ãƒ†ãƒ¬ãƒãƒ¼ãƒˆ
  StageRotate        // ã‚¹ãƒ†ãƒ¼ã‚¸å›è»¢
}

// ã‚¢ã‚¤ãƒ†ãƒ å®šç¾©ã‚¯ãƒ©ã‚¹
class Item {
  final String itemId;
  final String itemName;
  final ItemEffectType effectType;
  final bool isUsableByRunner;
  final String description;
  final int maxStack = 5; // æœ€å¤§æ‰€æŒæ•°

  Item({
    required this.itemId,
    required this.itemName,
    required this.effectType,
    required this.isUsableByRunner,
    required this.description,
  });
}
</file>

<file path="lib/models/player.dart">
// åº§æ¨™ç®¡ç†ç”¨ã‚¯ãƒ©ã‚¹ (Vector2Int)
class Vector2Int {
  int x, y;
  Vector2Int(this.x, this.y);

  @override
  bool operator ==(Object other) =>
      identical(this, other) ||
      other is Vector2Int && x == other.x && y == other.y;

  @override
  int get hashCode => x.hashCode ^ y.hashCode;
}

// å½¹å‰²å®šç¾©
enum PlayerRole { Oni, Runner }

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å®šç¾©
class Player {
  final int playerId;
  final PlayerRole role;
  Vector2Int position;
  bool hasActedThisTurn = false;
  Map<String, int> inventory = {}; // <itemId, æ‰€æŒæ•°>

  // é¬¼ã®é€²è¡Œæ–¹å‘ï¼ˆLockOniDirectionç”¨ï¼‰
  Vector2Int? lockedDirection; 

  // â–¼â–¼ è¿½åŠ ãŒå¿…è¦ã ã£ãŸå¤‰æ•°ãŸã¡ â–¼â–¼
  int diceModifier = 0; // ãƒ€ã‚¤ã‚¹ã®ç›®ã®è£œæ­£å€¤
  bool isMovementOverridden = false; // ç§»å‹•åˆ¶é™è§£é™¤ãƒ•ãƒ©ã‚°
  // â–²â–² ã“ã“ã¾ã§ â–²â–²

  Player({
    required this.playerId,
    required this.role,
    required this.position,
  });
}
</file>

<file path="lib/providers/game_rule_manager.dart">
import 'dart:convert';
import 'package:flutter_unity_widget/flutter_unity_widget.dart';
import '../models/game_data.dart';

class GameRuleManager {
  int currentTurn = 1;
  int maxTurn = 10;
  String currentPlayerId = "Runner"; // åˆæœŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
  String gameStatusMessage = "ã‚²ãƒ¼ãƒ é–‹å§‹å¾…æ©Ÿä¸­";
  bool hasRolledThisTurn = false;

  // â˜…ä¿®æ­£: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªç®¡ç†
  // Map<PlayerID, Map<ItemID, Count>>
  Map<String, Map<String, int>> allPlayerInventories = {
    "Runner": {},
    "Oni1": {},
    "Oni2": {},
    "Oni3": {},
  };

  // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åœ¨åº«ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
  Map<String, int> get currentInventory => allPlayerInventories[currentPlayerId] ?? {};

  void sendToUnity(UnityWidgetController? controller, String type, Map<String, dynamic> data) {
    if (controller == null) return;
    data['type'] = type;
    controller.postMessage(
      'GameManager',
      'OnReceiveFlutterMessage',
      jsonEncode(data),
    );
  }

  void rollDice(UnityWidgetController? controller) {
    if (hasRolledThisTurn) return; 

    int result = DateTime.now().millisecond % 6 + 1; 
    sendToUnity(controller, "DiceRolled", {"result": result.toString()});
    hasRolledThisTurn = true;
  }

  void useItem(UnityWidgetController? controller, String itemId) {
    // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰€æŒæ•°ã‚’ãƒã‚§ãƒƒã‚¯
    int count = currentInventory[itemId] ?? 0;
    if (count <= 0) {
      return; 
    }
    
    // Unityã¸ä½¿ç”¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    sendToUnity(controller, "UseItem", {"itemId": itemId});
    
    // UIä¸Šã§ã™ãæ¸›ã‚‰ã™ï¼ˆUnityå´ã§å´ä¸‹ã•ã‚Œã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ãŒã€åŸºæœ¬ã¯ä¿¡é ¼ã™ã‚‹ï¼‰
    // ã‚‚ã—å³å¯†ã«ã™ã‚‹ãªã‚‰Unityã‹ã‚‰ã®æˆåŠŸé€šçŸ¥ã‚’å¾…ã¤ã¹ãã ãŒã€ä»Šå›ã¯ç°¡æ˜“å®Ÿè£…
    currentInventory[itemId] = count - 1;
  }

  String? handleUnityMessage(Map<String, dynamic> data) {
    switch (data['type']) {
      case 'UnityReady':
        return "System: Unity Connected.";

      case 'TurnChange':
        hasRolledThisTurn = false; 
        currentPlayerId = data['playerId']; // æ‰‹ç•ªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–°
        return "Turn changed to $currentPlayerId";

      case 'StatusUpdate':
        return null;

      case 'DiceCalculated':
        String baseVal = data['base'];
        String bonusVal = data['bonus'];
        String totalVal = data['total'];
        if (int.parse(bonusVal) > 0) {
          return "ğŸ² å‡ºç›®[$baseVal] + ã‚¢ã‚¤ãƒ†ãƒ [$bonusVal] = ã€$totalValãƒã‚¹ã€‘é€²ã¿ã¾ã™ï¼";
        } else {
          return "ğŸ² å‡ºç›®[$baseVal] = ã€$totalValãƒã‚¹ã€‘é€²ã¿ã¾ã™ï¼";
        }

      // â˜…è¿½åŠ : ã‚¢ã‚¤ãƒ†ãƒ æ‹¾å¾—é€šçŸ¥ã®å‡¦ç†
      case 'ItemPickup':
        String pId = data['playerId'];
        String itemId = data['itemId'];
        
        if (!allPlayerInventories.containsKey(pId)) {
          allPlayerInventories[pId] = {};
        }
        allPlayerInventories[pId]![itemId] = (allPlayerInventories[pId]![itemId] ?? 0) + 1;
        
        return "âœ¨ $pId ãŒ $itemId ã‚’ç²å¾—ã—ã¾ã—ãŸï¼";

      case 'GameEnd':
        gameStatusMessage = data['result'];
        hasRolledThisTurn = true; 
        return "ğŸ ã‚²ãƒ¼ãƒ çµ‚äº†: ${data['result']}";

      default:
        return null;
    }
  }
}
</file>

<file path="unity/My project/Assets/Scripts/Game/MoveCalculator.cs">
using UnityEngine;
using System.Collections.Generic;

public static class MoveCalculator
{
    public static List<string> GetImmediateCandidates(PlayerController player)
    {
        List<string> candidates = new List<string>();
        
        if (!MapGenerator.AllSquares.ContainsKey(player.CurrentSquareId)) return candidates;
        Square currentSq = MapGenerator.AllSquares[player.CurrentSquareId];

        bool isRestrictedStraight = false;
        Square lastSq = null;

        // é¬¼ã®ç›´é€²ç¸›ã‚Šã¯ã€Œç§»å‹•ä¸­ã€ã‹ã¤ã€Œå‰å›ä½ç½®ãŒã‚ã‚‹ã€å ´åˆã®ã¿
        if (player.Role == "Oni" && player.RemainingSteps < player.TotalStepsInTurn)
        {
            if (!string.IsNullOrEmpty(player.LastSquareId) && MapGenerator.AllSquares.ContainsKey(player.LastSquareId))
            {
                lastSq = MapGenerator.AllSquares[player.LastSquareId];
                isRestrictedStraight = true;
            }
        }

        foreach (string neighborId in currentSq.ConnectedIds)
        {
            if (neighborId == player.LastSquareId) continue;

            Square neighborSq = MapGenerator.AllSquares[neighborId];

            // åº•é¢ã¸ã®ç§»å‹•ç¦æ­¢
            if (Vector3.Dot(neighborSq.transform.up, Vector3.down) > 0.9f) continue;

            if (player.Role == "Oni")
            {
                if (!IsStraightMove(currentSq, neighborSq)) continue;

                if (isRestrictedStraight && lastSq != null)
                {
                    if (!IsContinuousStraight(lastSq, currentSq, neighborSq)) continue;
                }
            }
            
            candidates.Add(neighborId);
        }

        return candidates;
    }

    private static bool IsStraightMove(Square a, Square b)
    {
        float dist = Vector3.Distance(a.transform.position, b.transform.position);
        if (dist > 1.2f) return false;

        Vector3 p1 = a.transform.position;
        Vector3 p2 = b.transform.position;
        int diffCount = 0;
        float epsilon = 0.1f;
        if (Mathf.Abs(p1.x - p2.x) > epsilon) diffCount++;
        if (Mathf.Abs(p1.y - p2.y) > epsilon) diffCount++;
        if (Mathf.Abs(p1.z - p2.z) > epsilon) diffCount++;

        return diffCount <= 2;
    }

    private static bool IsContinuousStraight(Square last, Square current, Square next)
    {
        Vector3 v1 = (current.transform.position - last.transform.position).normalized;
        Vector3 v2 = (next.transform.position - current.transform.position).normalized;
        float dot = Vector3.Dot(v1, v2);

        if (dot > 0.9f) return true;

        float distLastToNext = Vector3.Distance(last.transform.position, next.transform.position);
        bool isFaceChange = (last.FaceName != current.FaceName) || (current.FaceName != next.FaceName);

        if (isFaceChange)
        {
            if (distLastToNext > 1.3f) return true;
        }

        return false;
    }
}
</file>

<file path="unity/My project/Assets/Scripts/Game/MapGenerator.cs">
using UnityEngine;
using System.Collections.Generic;
using DG.Tweening;

public class MapGenerator : MonoBehaviour
{
    [Header("è¨­å®š")]
    public GameObject cubePrefab; // ãƒ‘ãƒãƒ«ã®ãƒ—ãƒ¬ãƒãƒ–
    public float spacing = 1.0f;  // ãƒã‚¹ç›®ã®é–“éš”ï¼ˆ1.0å›ºå®šæ¨å¥¨ï¼‰
    public int mapSize = 5;       // ãƒãƒƒãƒ—ã®ä¸€è¾ºã®æ•° (å¥‡æ•°æ¨å¥¨: 5)

    [Header("ãƒ‘ãƒãƒ«è¨­å®š")]
    // 1.0 x 1.0 ã®æ­£æ–¹å½¢ã§ã€åšã¿ãŒ0.1ã®ãƒ‘ãƒãƒ«
    public Vector3 panelScale = new Vector3(1.0f, 0.1f, 1.0f); 

    public static Dictionary<string, Square> AllSquares = new Dictionary<string, Square>();
    public Transform MapPivot;

    void Awake()
    {
        GenerateMap();
    }

    public void GenerateMap()
    {
        // è¦ªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚»ãƒƒãƒˆ
        if (MapPivot != null)
        {
            foreach (Transform child in MapPivot) Destroy(child.gameObject);
        }
        else
        {
            GameObject pivotObj = new GameObject("MapPivot");
            pivotObj.transform.parent = this.transform;
            pivotObj.transform.localPosition = Vector3.zero;
            MapPivot = pivotObj.transform;
        }
        
        AllSquares.Clear();

        // --- åº§æ¨™è¨ˆç®—ã®æº–å‚™ ---
        // ãƒãƒƒãƒ—å…¨ä½“ã®ç‰©ç†çš„ãªåŠå¾„ï¼ˆä¸­å¿ƒã‹ã‚‰è¡¨é¢ã¾ã§ã®è·é›¢ï¼‰
        // ä¾‹: size=5, spacing=1.0 ã®å ´åˆã€å¹…ã¯5.0ã€‚ä¸­å¿ƒ(0)ã‹ã‚‰ç«¯ã¾ã§ã¯2.5ã€‚
        float mapRadius = (mapSize * spacing) / 2.0f;

        // ãƒ‘ãƒãƒ«ã®ä¸­å¿ƒåº§æ¨™ã‚’æ±ºã‚ã‚‹ãŸã‚ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
        // è¡¨é¢(2.5)ã‹ã‚‰ã€ãƒ‘ãƒãƒ«ã®åšã¿ã®åŠåˆ†(0.05)ã ã‘å†…å´ã«å…¥ã‚ŒãŸå ´æ‰€(2.45)ã«é…ç½®ã™ã‚‹ã¨
        // ãƒ‘ãƒãƒ«ã®å¤–å´é¢ãŒã´ã£ãŸã‚Š2.5ã®ãƒ©ã‚¤ãƒ³ã«æƒã†ã€‚
        float facePos = mapRadius - (panelScale.y / 2.0f);

        // --- 6ã¤ã®é¢ã‚’ç‹¬ç«‹ã—ã¦ç”Ÿæˆ ---
        // ã“ã‚Œã«ã‚ˆã‚Šã€è§’ï¼ˆã‚³ãƒ¼ãƒŠãƒ¼ï¼‰ã«ã¯3æšã®ãƒ‘ãƒãƒ«ãŒç”Ÿæˆã•ã‚Œã€éš™é–“ãªãåŸ‹ã¾ã‚‹
        
        GenerateFace("Top",    Vector3.up,      facePos);
        GenerateFace("Bottom", Vector3.down,    facePos);
        GenerateFace("Front",  Vector3.forward, facePos);
        GenerateFace("Back",   Vector3.back,    facePos);
        GenerateFace("Right",  Vector3.right,   facePos);
        GenerateFace("Left",   Vector3.left,    facePos);

        ConnectNeighbors();
        Debug.Log($"ãƒãƒƒãƒ—ç”Ÿæˆå®Œäº†: {AllSquares.Count}å€‹ (6é¢ç‹¬ç«‹ç”Ÿæˆæ–¹å¼)");
    }

    // æŒ‡å®šã—ãŸé¢ã®ãƒ‘ãƒãƒ«ã‚’ä¸€æ‹¬ç”Ÿæˆã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    void GenerateFace(string faceName, Vector3 normal, float distFromCenter)
    {
        int blockLayerIndex = LayerMask.NameToLayer("Block");
        
        // è»¸ã®å®šç¾©
        // normalãŒ Yè»¸(Up/Down)ãªã‚‰ -> X, Z ã§ãƒ«ãƒ¼ãƒ—
        // normalãŒ Zè»¸(Front/Back)ãªã‚‰ -> X, Y ã§ãƒ«ãƒ¼ãƒ—
        // normalãŒ Xè»¸(Right/Left)ãªã‚‰ -> Z, Y ã§ãƒ«ãƒ¼ãƒ—
        
        for (int i = 0; i < mapSize; i++)
        {
            for (int j = 0; j < mapSize; j++)
            {
                // ã‚°ãƒªãƒƒãƒ‰åº§æ¨™ (-2.0, -1.0, 0, 1.0, 2.0) ã®ã‚ˆã†ã«ä¸­å¿ƒ0åŸºæº–ã§è¨ˆç®—
                float offset = (mapSize - 1) * spacing / 2.0f;
                float u = (i * spacing) - offset;
                float v = (j * spacing) - offset;

                Vector3 localPos = Vector3.zero;
                Vector2Int coord = Vector2Int.zero;
                string id = "";

                // é¢ã”ã¨ã®åº§æ¨™å¤‰æ›
                if (faceName == "Top" || faceName == "Bottom")
                {
                    // Yè»¸å›ºå®šã€X(u)ãƒ»Z(v)å¹³é¢
                    // normalæ–¹å‘ * distFromCenter ã§é¢ã®é«˜ã•ãŒæ±ºã¾ã‚‹
                    localPos = (normal * distFromCenter) + new Vector3(u, 0, v);
                    
                    // ID: Top_0_0 ã€œ Top_4_4
                    id = $"{faceName}_{i}_{j}";
                    coord = new Vector2Int(i + 1, j + 1);
                }
                else if (faceName == "Front" || faceName == "Back")
                {
                    // Zè»¸å›ºå®šã€X(u)ãƒ»Y(v)å¹³é¢
                    localPos = (normal * distFromCenter) + new Vector3(u, v, 0);
                    
                    id = $"{faceName}_{i}_{j}";
                    coord = new Vector2Int(i + 1, j + 1);
                }
                else if (faceName == "Right" || faceName == "Left")
                {
                    // Xè»¸å›ºå®šã€Z(u)ãƒ»Y(v)å¹³é¢
                    // â€»å³é¢ãƒ»å·¦é¢ã¯ Z, Y ã®é †ã§å›ã™ã¨è‡ªç„¶
                    localPos = (normal * distFromCenter) + new Vector3(0, v, u);
                    
                    id = $"{faceName}_{i}_{j}"; // IDã¯ Z_Y (æ¨ª_ç¸¦)
                    coord = new Vector2Int(i + 1, j + 1);
                }

                // ç”Ÿæˆå‡¦ç†
                GameObject obj = Instantiate(cubePrefab, MapPivot);
                obj.name = $"Panel_{id}";
                obj.transform.localPosition = localPos;
                
                // å›è»¢: ä¸Šæ–¹å‘(Y)ã‚’æ³•ç·š(Normal)ã«å‘ã‘ã‚‹
                obj.transform.rotation = Quaternion.FromToRotation(Vector3.up, normal);
                
                // ã‚¹ã‚±ãƒ¼ãƒ«
                obj.transform.localScale = panelScale;

                // ãƒ¬ã‚¤ãƒ¤ãƒ¼
                if (blockLayerIndex != -1) obj.layer = blockLayerIndex;

                // Squareã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
                Square sq = obj.GetComponent<Square>();
                if (sq == null) sq = obj.AddComponent<Square>();

                sq.FaceName = faceName;
                sq.ID = id;
                sq.LocalCoordinates = coord;
                sq.IsBlocked = (faceName == "Bottom"); // åº•é¢ã¯ãƒ–ãƒ­ãƒƒã‚¯æ‰±ã„ç­‰ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚Œã°
                sq.SetupNormal();

                if (!AllSquares.ContainsKey(sq.ID))
                {
                    AllSquares.Add(sq.ID, sq);
                }
            }
        }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¸å›è»¢
    public void RotateStage(Vector3 axis, float angle, float duration)
    {
        if (MapPivot == null) return;
        MapPivot.DORotate(axis * angle, duration, RotateMode.WorldAxisAdd)
            .SetEase(Ease.InOutQuad);
    }

    // éš£æ¥ãƒã‚¹ã®æ¥ç¶š
    void ConnectNeighbors()
    {
        // æ¥ç¶šè·é›¢ã®é–¾å€¤
        // ãƒ‘ãƒãƒ«é–“ã®è·é›¢ã¯1.0ã€‚è§’ï¼ˆã‚³ãƒ¼ãƒŠãƒ¼ï¼‰ã§ã®è·é›¢ã¯ âˆš((0.5)^2 + (0.5)^2) â‰’ 0.7 ç¨‹åº¦ã ãŒã€
        // ç‹¬ç«‹ç”Ÿæˆã—ãŸãƒ‘ãƒãƒ«ä¸­å¿ƒé–“ã®è·é›¢ã¯ã‚³ãƒ¼ãƒŠãƒ¼ã§ã‚‚ ç´„1.0 ã€œ 1.1 ç¨‹åº¦ã«ãªã‚‹ã€‚
        // ä½™è£•ã‚’æŒã£ã¦ 1.5 å€ç¨‹åº¦ã§æ¥ç¶šåˆ¤å®šã‚’è¡Œã†
        float connectThreshold = spacing * 1.5f;

        foreach (var kvp in AllSquares)
        {
            Square current = kvp.Value;
            current.ConnectedIds.Clear();
            foreach (var targetKvp in AllSquares)
            {
                Square target = targetKvp.Value;
                if (current == target) continue;

                float dist = Vector3.Distance(current.transform.position, target.transform.position);
                if (dist <= connectThreshold)
                {
                    // è£é¢åŒå£«ãŒã¤ãªãŒã‚‰ãªã„ã‚ˆã†ã«ã€æ³•ç·šã®å‘ããƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã‚‚è‰¯ã„ãŒã€
                    // 5x5ã‚µã‚¤ã‚ºãªã‚‰è·é›¢ã ã‘ã§ååˆ†ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
                    if (!target.IsBlocked) current.ConnectedIds.Add(target.ID);
                }
            }
        }
    }
}
</file>

<file path="unity/My project/Assets/Scripts/Game/Square.cs">
using UnityEngine;
using System.Collections.Generic;

// â˜…ä¿®æ­£: AddDiceValueã‚’å‰Šé™¤ã—ã€3ç¨®é¡(SpeedUp, Teleport, StageRotate) + Block/None ã«æ•´ç†
public enum ItemType { None, SpeedUp, Block, Teleport, StageRotate }

public class Square : MonoBehaviour
{
    [Header("åŸºæœ¬æƒ…å ±")]
    public string ID; 
    public string FaceName; 
    public Vector2Int LocalCoordinates; 

    public Vector3 CurrentNormal => transform.up;
    public Vector3 UpVector => transform.up;

    [Header("çŠ¶æ…‹")]
    public bool IsBlocked = false; 
    public ItemType CurrentItem = ItemType.None;
    
    private GameObject itemVisual; 
    public List<string> ConnectedIds = new List<string>();

    public void SetupNormal() { }

    public void SetHighlight(bool isActive)
    {
        var r = GetComponent<Renderer>();
        if (r != null) r.material.color = isActive ? Color.yellow : Color.white;
    }

    public void SpawnItem(ItemType type, GameObject prefab)
    {
        if (CurrentItem != ItemType.None) return;
        CurrentItem = type;
        if (prefab != null)
        {
            // ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
            itemVisual = Instantiate(prefab, transform.position + CurrentNormal * 0.5f, Quaternion.identity);
            itemVisual.transform.parent = this.transform;
            itemVisual.transform.localRotation = Quaternion.identity;

            // ã‚µã‚¤ã‚ºè£œæ­£
            itemVisual.transform.localScale = new Vector3(0.5f, 5.0f, 0.5f);

            // â˜…ä¿®æ­£: è‰²åˆ†ã‘å‡¦ç† (AddDiceValueå‰Šé™¤)
            Renderer r = itemVisual.GetComponent<Renderer>();
            if (r != null)
            {
                switch (type)
                {
                    case ItemType.SpeedUp:
                        r.material.color = Color.yellow; // é»„è‰²
                        break;
                    case ItemType.Teleport:
                        r.material.color = Color.magenta; // ç´«
                        break;
                    case ItemType.StageRotate:
                        r.material.color = new Color(1f, 0.5f, 0f); // ã‚ªãƒ¬ãƒ³ã‚¸
                        break;
                    default:
                        r.material.color = Color.white;
                        break;
                }
            }
        }
    }

    public void RemoveItem()
    {
        CurrentItem = ItemType.None;
        if (itemVisual != null)
        {
            Destroy(itemVisual);
            itemVisual = null;
        }
    }
}
</file>

<file path="unity/My project/Assets/Scripts/Game/PlayerController.cs">
using UnityEngine;
using DG.Tweening; 
using UnityEngine.UI;
using System.Collections.Generic;
using FlutterUnityIntegration; // è¿½åŠ 

public class PlayerController : MonoBehaviour
{
    public string PlayerId;
    public string Role;
    public string CurrentSquareId;
    public string LastSquareId;        
    public int RemainingSteps;        
    public int DiceBonus = 0;
    public int TotalStepsInTurn = 0;

    // â˜…è¿½åŠ : å…ƒã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ä¿æŒ
    private Vector3 originalScale;

    [Header("è¦‹ãŸç›®ãƒ»UI")]
    public Renderer meshRenderer; 
    public Text nameText; 
    public List<ItemType> OwnedItems = new List<ItemType>();

    void Start()
    {
        // â˜…è¿½åŠ : é–‹å§‹æ™‚ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ä¿å­˜
        originalScale = transform.localScale;
    }

    public void Setup(string id, string role, string startSquareId)
    {
        this.PlayerId = id;
        this.Role = role;
        this.CurrentSquareId = startSquareId;
        this.LastSquareId = ""; 
        this.RemainingSteps = 0;
        this.DiceBonus = 0;
        this.TotalStepsInTurn = 0;

        if (nameText != null)
        {
            nameText.text = id;
            nameText.color = (role == "Oni") ? Color.red : Color.cyan;
        }
    }

    public void SetMaterial(Material mat)
    {
        if (meshRenderer != null) meshRenderer.material = mat;
        else 
        {
            var r = GetComponentInChildren<Renderer>();
            if(r != null) r.material = mat;
        }
    }

    public void MoveOneStep(string nextSquareId, System.Action onComplete)
    {
        if (!MapGenerator.AllSquares.ContainsKey(nextSquareId)) return;

        LastSquareId = CurrentSquareId;
        CurrentSquareId = nextSquareId;
        RemainingSteps--; 

        Square nextSq = MapGenerator.AllSquares[nextSquareId];
        Vector3 targetPos = nextSq.transform.position;
        Vector3 normal = nextSq.UpVector;

        float heightOffset = 0.6f; 
        Vector3 goal = targetPos + normal * heightOffset;

        Vector3 moveDir = (goal - transform.position).normalized;
        if (moveDir != Vector3.zero)
        {
            Quaternion targetRot = Quaternion.LookRotation(moveDir, normal);
            transform.DORotateQuaternion(targetRot, 0.2f);
        }

        transform.DOJump(goal, 0.5f, 1, 0.4f).SetEase(Ease.Linear)
            .OnComplete(() => {
                UpdateRotation(normal);
                CheckItemPickup();
                onComplete?.Invoke(); 
            });
    }

    public void ForceMoveTo(string targetSquareId, System.Action onComplete)
    {
        if (!MapGenerator.AllSquares.ContainsKey(targetSquareId)) return;

        LastSquareId = CurrentSquareId;
        CurrentSquareId = targetSquareId;
        
        Square nextSq = MapGenerator.AllSquares[targetSquareId];
        Vector3 targetPos = nextSq.transform.position;
        Vector3 normal = nextSq.UpVector;
        float heightOffset = 0.6f; 
        Vector3 goal = targetPos + normal * heightOffset;

        // â˜…ä¿®æ­£: 1.0f ã§ã¯ãªã originalScale ã«æˆ»ã™ã“ã¨ã§å·¨å¤§åŒ–ã‚’é˜²ã
        transform.DOScale(Vector3.zero, 0.3f).OnComplete(() => {
            transform.position = goal;
            UpdateRotation(normal);
            transform.DOScale(originalScale, 0.3f).OnComplete(() => {
                onComplete?.Invoke();
            });
        });
    }

    void UpdateRotation(Vector3 upVector)
    {
        Vector3 forward = transform.forward;
        if (Mathf.Abs(Vector3.Dot(forward, upVector)) > 0.99f) forward = Vector3.forward; 
        Quaternion targetRot = Quaternion.LookRotation(forward, upVector);
        Quaternion upFix = Quaternion.FromToRotation(transform.up, upVector);
        transform.rotation = upFix * transform.rotation;
    }

    void CheckItemPickup()
    {
        if (MapGenerator.AllSquares.ContainsKey(CurrentSquareId))
        {
            Square currentSq = MapGenerator.AllSquares[CurrentSquareId];
            if (currentSq.CurrentItem != ItemType.None)
            {
                string itemTypeStr = currentSq.CurrentItem.ToString();
                Debug.Log($"<color=yellow>ã€ITEMã€‘{PlayerId} ã¯ {itemTypeStr} ã‚’æ‹¾ã£ãŸï¼</color>");
                
                OwnedItems.Add(currentSq.CurrentItem);
                
                // â˜…è¿½åŠ : Flutterã¸ã‚¢ã‚¤ãƒ†ãƒ å–å¾—ã‚’é€šçŸ¥ã™ã‚‹
                // JSON: {"type": "ItemPickup", "playerId": "Oni1", "itemId": "SpeedUp"}
                string json = $"{{\"type\":\"ItemPickup\", \"playerId\":\"{PlayerId}\", \"itemId\":\"{itemTypeStr}\"}}";
                if (UnityMessageManager.Instance != null) UnityMessageManager.Instance.SendMessageToFlutter(json);

                currentSq.RemoveItem();
            }
        }
    }
}
</file>

<file path="unity/My project/Assets/Scripts/Managers/GameManager.cs">
using UnityEngine;
using UnityEngine.Scripting;
using Newtonsoft.Json;
using FlutterUnityIntegration;
using BlockOni.Models;
using DG.Tweening; 
using UnityEngine.UI; 
using System.Collections;
using System.Collections.Generic;
using System.Linq; 

public class GameManager : MonoBehaviour
{
    public static GameManager Instance;

    [Header("ãƒ‡ãƒãƒƒã‚°è¨­å®š")]
    public bool isDebugMode = true;

    [Header("å‚ç…§è¨­å®š")]
    public GameObject playerPrefab;
    public MapGenerator mapGenerator; 
    public Text diceResultText;
    public Text gameInfoText; 
    public Camera mainCamera;
    public GameObject resultPanel; 
    public Text resultText;

    [Header("ãƒãƒ†ãƒªã‚¢ãƒ«ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ")]
    public Material matOni;
    public Material matRunner;
    public GameObject itemPrefab;

    [Header("ã‚²ãƒ¼ãƒ çŠ¶æ…‹")]
    public List<PlayerController> players = new List<PlayerController>();
    public int currentPlayerIndex = 0;
    public int turnCount = 1;
    public int MaxTurnLimit = 10;
    
    private PlayerController CurrentPlayer => players[currentPlayerIndex];
    private List<string> activeMovableIds = new List<string>(); 

    private bool isWaitingForDice = true;
    private bool isWaitingForDirection = false; 
    private bool isMoving = false; 
    private bool isGameEnded = false;
    private bool isEventPlaying = false; 

    void Awake()
    {
        Instance = this;
        if (mainCamera == null) mainCamera = Camera.main;
        if (mapGenerator == null) mapGenerator = FindObjectOfType<MapGenerator>();
    }

    void Start()
    {
        string readyJson = $"{{\"type\":\"UnityReady\"}}";
        if (UnityMessageManager.Instance != null) UnityMessageManager.Instance.SendMessageToFlutter(readyJson);
        
        DOVirtual.DelayedCall(0.1f, InitializeGame);
    }

    void InitializeGame()
    {
        foreach(var p in players) if(p != null) Destroy(p.gameObject);
        players.Clear();

        var camController = mainCamera.GetComponent<CameraController>();
        if (camController != null && mapGenerator.MapPivot != null) camController.SetTarget(mapGenerator.MapPivot);

        SpawnPlayer("Runner", "Runner", "Top_2_2", matRunner);
        SpawnPlayer("Oni1", "Oni",    "Top_0_0", matOni);
        SpawnPlayer("Oni2", "Oni",    "Top_4_0", matOni);
        SpawnPlayer("Oni3", "Oni",    "Top_0_4", matOni);

        if (isDebugMode) SpawnRandomItems(5);
        if (resultPanel != null) resultPanel.SetActive(false);
        isGameEnded = false;
        isEventPlaying = false;

        currentPlayerIndex = 0;
        turnCount = 1;
        isWaitingForDice = true;
        isWaitingForDirection = false;
        isMoving = false;

        UpdateGameInfoUI();
        SendTurnChangeToFlutter(); 
        
        if(isDebugMode) Debug.Log($"ã‚²ãƒ¼ãƒ é–‹å§‹: ç¬¬{turnCount}ã‚¿ãƒ¼ãƒ³ / æ‰‹ç•ª: {CurrentPlayer.PlayerId}");
    }

    void Update()
    {
        if (isGameEnded || isEventPlaying) return; 

        if (isDebugMode && Input.GetKeyDown(KeyCode.R))
        {
            if (CurrentPlayer.RemainingSteps <= 0) ReceiveDiceResult(Random.Range(1, 7));
        }

        if (Input.GetMouseButtonDown(0)) HandleClickInteraction();
    }

    void ReceiveDiceResult(int baseResult)
    {
        Debug.Log($"ReceiveDiceResult called: base={baseResult}");
        try
        {
            int bonus = CurrentPlayer.DiceBonus;
            int finalResult = baseResult + bonus;

            string json = $"{{\"type\":\"DiceCalculated\", \"base\":\"{baseResult}\", \"bonus\":\"{bonus}\", \"total\":\"{finalResult}\"}}";
            if (UnityMessageManager.Instance != null) UnityMessageManager.Instance.SendMessageToFlutter(json);

            CurrentPlayer.DiceBonus = 0;
            UpdateGameInfoUI();
            OnDiceRolled(finalResult);
        }
        catch (System.Exception e)
        {
            Debug.LogError($"ReceiveDiceResult Error: {e.Message}");
        }
    }

    void OnDiceRolled(int result)
    {
        ShowDiceAnimation(result);
        CurrentPlayer.RemainingSteps = result;
        CurrentPlayer.TotalStepsInTurn = result; 
        isWaitingForDice = false; 
        ProcessNextStep();
    }

    void ProcessNextStep()
    {
        if (CurrentPlayer.RemainingSteps <= 0)
        {
            Debug.Log("ç§»å‹•çµ‚äº†");
            DOVirtual.DelayedCall(0.5f, CheckWinCondition);
            return;
        }

        List<string> candidates = MoveCalculator.GetImmediateCandidates(CurrentPlayer);
        foreach(var sq in MapGenerator.AllSquares.Values) sq.SetHighlight(false);
        activeMovableIds.Clear();

        if (candidates.Count == 0)
        {
            Debug.Log("è¡Œãæ­¢ã¾ã‚Šï¼");
            CurrentPlayer.RemainingSteps = 0;
            CheckWinCondition();
        }
        else if (candidates.Count == 1)
        {
            isWaitingForDirection = true;
            activeMovableIds = candidates;
            MapGenerator.AllSquares[candidates[0]].SetHighlight(true);
        }
        else
        {
            Debug.Log($"ç§»å‹•å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„ (æ®‹ã‚Š{CurrentPlayer.RemainingSteps}æ­©)");
            isWaitingForDirection = true;
            activeMovableIds = candidates;
            foreach (string id in candidates)
            {
                if(MapGenerator.AllSquares.ContainsKey(id))
                    MapGenerator.AllSquares[id].SetHighlight(true);
            }
        }
    }

    void ExecuteOneStep(string targetId)
    {
        isWaitingForDirection = false;
        foreach(var sq in MapGenerator.AllSquares.Values) sq.SetHighlight(false);
        activeMovableIds.Clear();

        CurrentPlayer.MoveOneStep(targetId, () => 
        {
            UpdateGameInfoUI();
            ProcessNextStep();
        });
    }

    void HandleClickInteraction()
    {
        if (isGameEnded || isEventPlaying || isMoving) return;
        if (!isWaitingForDirection) return;

        Ray ray = mainCamera.ScreenPointToRay(Input.mousePosition);
        int layerMask = LayerMask.GetMask("Block"); 

        if (Physics.Raycast(ray, out RaycastHit hit, 100f, layerMask))
        {
            GameObject hitObj = hit.collider.gameObject;
            Square clickedSquare = hitObj.GetComponent<Square>();
            if (clickedSquare == null) return;

            if (activeMovableIds.Contains(clickedSquare.ID))
            {
                hitObj.transform.DOPunchScale(Vector3.one * 0.2f, 0.2f, 10, 1);
                ExecuteOneStep(clickedSquare.ID);
            }
        }
    }
    
    public void ActivateItem(string itemType)
    {
        if (isGameEnded || isEventPlaying) return;
        Debug.Log($"ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨: {itemType}");

        switch(itemType)
        {
            case "Teleport":
                var validCandidates = MapGenerator.AllSquares.Values
                    .Where(sq => Vector3.Dot(sq.transform.up, Vector3.down) < 0.5f) 
                    .Select(sq => sq.ID)
                    .ToList();

                if (validCandidates.Count > 0)
                {
                    string randomId = validCandidates[Random.Range(0, validCandidates.Count)];
                    CurrentPlayer.ForceMoveTo(randomId, () => {
                        CheckWinCondition();
                    });
                }
                else
                {
                    Debug.LogWarning("ãƒ¯ãƒ¼ãƒ—å¯èƒ½ãªãƒã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
                }
                break;

            case "StageRotate":
                StartCoroutine(RotateStageEvent(1.0f));
                break;
            
            // â˜…ä¿®æ­£: AddDiceValueã‚’å‰Šé™¤ã—ã€SpeedUpã®ã¿ã«ã™ã‚‹
            case "SpeedUp":
                if (!isWaitingForDice)
                {
                    Debug.LogWarning("ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã£ãŸå¾Œãªã®ã§åŠ é€Ÿã‚¢ã‚¤ãƒ†ãƒ ã¯ä½¿ãˆã¾ã›ã‚“");
                    return; 
                }
                CurrentPlayer.DiceBonus += 2;
                UpdateGameInfoUI();
                break;
        }
    }

    void SpawnRandomItems(int count)
    {
        if (itemPrefab == null) return;

        var availableSquares = MapGenerator.AllSquares.Values
            .Where(sq => sq.CurrentItem == ItemType.None)
            .ToList();

        if (count > availableSquares.Count) count = availableSquares.Count;

        // â˜…ä¿®æ­£: ã‚¢ã‚¤ãƒ†ãƒ ç¨®åˆ¥ã‚’3ç¨®é¡ã«é™å®š
        List<ItemType> allTypes = new List<ItemType> { 
            ItemType.SpeedUp, 
            ItemType.Teleport, 
            ItemType.StageRotate 
        };

        int spawnedCount = 0;

        while (spawnedCount < count && availableSquares.Count > 0)
        {
            ItemType nextType;

            if (spawnedCount < allTypes.Count)
            {
                // ãƒ•ã‚§ãƒ¼ã‚ºA: æœ€åˆã®3å›ã§å…¨ç¨®é¡ã‚’é…ç½®
                nextType = allTypes[spawnedCount];
            }
            else
            {
                // ãƒ•ã‚§ãƒ¼ã‚ºB: æ®‹ã‚Šã¯ãƒ©ãƒ³ãƒ€ãƒ 
                nextType = allTypes[Random.Range(0, allTypes.Count)];
            }

            int targetIndex = Random.Range(0, availableSquares.Count);
            Square targetSq = availableSquares[targetIndex];

            targetSq.SpawnItem(nextType, itemPrefab);

            availableSquares.RemoveAt(targetIndex);
            
            spawnedCount++;
        }
        
        Debug.Log($"ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆå®Œäº†: {spawnedCount}å€‹ (3ç¨®é¡é…ç½®ä¿è¨¼æ¸ˆã¿)");
    }

    void SpawnPlayer(string id, string role, string startSquareId, Material mat)
    {
        if (MapGenerator.AllSquares.ContainsKey(startSquareId))
        {
            Square sq = MapGenerator.AllSquares[startSquareId];
            Vector3 startPos = sq.transform.position;
            Vector3 normal = sq.UpVector;
            float heightOffset = 0.6f;
            GameObject pObj = Instantiate(playerPrefab, startPos + normal * heightOffset, Quaternion.identity);
            PlayerController pc = pObj.GetComponent<PlayerController>();
            pc.Setup(id, role, startSquareId);
            pc.SetMaterial(mat);
            players.Add(pc);
        }
    }

    void UpdateGameInfoUI() 
    {
        if (gameInfoText != null && players.Count > 0)
        {
            string role = (CurrentPlayer.Role == "Oni") ? "é¬¼" : "é€ƒèµ°è€…";
            string steps = (CurrentPlayer.RemainingSteps > 0) ? $" æ®‹ã‚Š{CurrentPlayer.RemainingSteps}æ­©" : "";
            gameInfoText.text = $"Turn {turnCount}/{MaxTurnLimit}\nPlayer: {CurrentPlayer.PlayerId} ({role}){steps}";

            string statusMsg = $"Turn {turnCount} / æ‰‹ç•ª: {CurrentPlayer.PlayerId}";
            if (CurrentPlayer.RemainingSteps > 0) statusMsg += $" (æ®‹ã‚Š{CurrentPlayer.RemainingSteps}æ­©)";
            
            string json = $"{{\"type\":\"StatusUpdate\", \"message\":\"{statusMsg}\"}}";
            if (UnityMessageManager.Instance != null) UnityMessageManager.Instance.SendMessageToFlutter(json);
        }
    }

    void SendTurnChangeToFlutter()
    {
        string json = $"{{\"type\":\"TurnChange\", \"playerId\":\"{CurrentPlayer.PlayerId}\"}}";
        if (UnityMessageManager.Instance != null) UnityMessageManager.Instance.SendMessageToFlutter(json);
    }

    [Preserve] 
    public void OnReceiveFlutterMessage(string jsonMessage)
    {
        Debug.Log($"<color=cyan>ã€Flutterå—ä¿¡ã€‘: {jsonMessage}</color>");
        try
        {
            var data = JsonConvert.DeserializeObject<Dictionary<string, string>>(jsonMessage);
            if (data == null || !data.ContainsKey("type")) return;

            switch (data["type"])
            {
                case "DiceRolled":
                    if (isEventPlaying || CurrentPlayer.RemainingSteps > 0) 
                    {
                        Debug.LogWarning($"ãƒ€ã‚¤ã‚¹å‘½ä»¤ã‚’ç„¡è¦–: Event={isEventPlaying}, Steps={CurrentPlayer.RemainingSteps}");
                        return;
                    }
                    if (!isWaitingForDice && CurrentPlayer.RemainingSteps > 0)
                    {
                        Debug.LogWarning("ãƒ€ã‚¤ã‚¹ä¸å¯çŠ¶æ…‹");
                        return;
                    }

                    if(data.ContainsKey("result")) ReceiveDiceResult(int.Parse(data["result"]));
                    break;

                case "UseItem":
                    if(data.ContainsKey("itemId")) ActivateItem(data["itemId"]);
                    break;
            }
        }
        catch(System.Exception e)
        {
            Debug.LogError($"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã‚¨ãƒ©ãƒ¼: {e.Message}");
        }
    }

    void ShowDiceAnimation(int result)
    {
        if (diceResultText != null)
        {
            diceResultText.text = result.ToString();
            diceResultText.transform.localScale = Vector3.zero;
            diceResultText.transform.DOScale(1.5f, 0.5f).SetEase(Ease.OutBounce)
                .OnComplete(() => {
                    DOVirtual.DelayedCall(0.5f, () => { diceResultText.text = ""; });
                });
        }
    }

    void CheckWinCondition()
    {
        var runner = players.FirstOrDefault(p => p.Role == "Runner");
        var onis = players.Where(p => p.Role == "Oni").ToList();
        if (runner == null) return;
        
        bool oniWin = false;
        foreach (var oni in onis)
        {
            if (oni.CurrentSquareId == runner.CurrentSquareId)
            {
                oniWin = true;
                break;
            }
        }
        
        if (oniWin) 
        {
            ShowResult("ONI TEAM WIN!");
            return;
        }

        if (turnCount >= MaxTurnLimit && currentPlayerIndex == players.Count - 1)
        {
            ShowResult("RUNNER WINS! (Time Up)");
            return;
        }

        NextTurn();
    }

    void ShowResult(string message)
    {
        isGameEnded = true;
        if (resultPanel != null && resultText != null)
        {
            resultPanel.SetActive(true);
            resultText.text = message;
            resultText.transform.localScale = Vector3.zero;
            resultText.transform.DOScale(1.0f, 0.5f).SetEase(Ease.OutBack);
        }
        string json = $"{{\"type\":\"GameEnd\", \"result\":\"{message}\"}}";
        if (UnityMessageManager.Instance != null) UnityMessageManager.Instance.SendMessageToFlutter(json);
        Debug.Log($"<color=red>ã€GAME SETã€‘{message}</color>");
    }

    void NextTurn()
    {
        if (isGameEnded) return;
        
        currentPlayerIndex = (currentPlayerIndex + 1) % players.Count;
        if (currentPlayerIndex == 0) turnCount++;
        
        CurrentPlayer.RemainingSteps = 0;
        isWaitingForDice = true; 
        isWaitingForDirection = false;
        
        UpdateGameInfoUI();
        SendTurnChangeToFlutter();

        if (currentPlayerIndex == 0 && turnCount > 1 && (turnCount - 1) % 4 == 0)
        {
            isWaitingForDice = false; 
            StartCoroutine(RotateStageEvent());
        }
        else
        {
            if(isDebugMode) Debug.Log($"ç¬¬{turnCount}ã‚¿ãƒ¼ãƒ³ / æ¬¡: {CurrentPlayer.PlayerId}");
        }
    }

    IEnumerator RotateStageEvent(float duration = 2.0f)
    {
        isEventPlaying = true;
        foreach(var p in players) p.transform.SetParent(mapGenerator.MapPivot);
        
        Vector3 axis = (Random.value > 0.5f) ? Vector3.right : Vector3.forward;
        mapGenerator.RotateStage(axis, 90f, duration);
        yield return new WaitForSeconds(duration);
        
        foreach(var p in players) p.transform.SetParent(null);

        CheckAndTeleportBottomPlayers();

        isEventPlaying = false;
        isWaitingForDice = true; 
        isWaitingForDirection = false;
        
        SendTurnChangeToFlutter();
    }

    void CheckAndTeleportBottomPlayers()
    {
        foreach(var p in players)
        {
            if(!MapGenerator.AllSquares.ContainsKey(p.CurrentSquareId)) continue;
            
            Square currentSq = MapGenerator.AllSquares[p.CurrentSquareId];
            
            if (Vector3.Dot(currentSq.transform.up, Vector3.down) > 0.9f)
            {
                Debug.Log($"{p.PlayerId} is on BOTTOM face! Teleporting...");
                Square targetSq = FindTopSquareAt(currentSq.transform.position.x, currentSq.transform.position.z);
                
                if (targetSq != null)
                {
                    p.CurrentSquareId = targetSq.ID;
                    Vector3 targetPos = targetSq.transform.position;
                    Vector3 normal = targetSq.UpVector;
                    float heightOffset = 0.6f;
                    p.transform.position = targetPos + normal * heightOffset;
                    
                    Vector3 forward = p.transform.forward;
                    if (Mathf.Abs(Vector3.Dot(forward, normal)) > 0.99f) forward = Vector3.forward;
                    p.transform.rotation = Quaternion.LookRotation(forward, normal);
                }
            }
        }
    }

    Square FindTopSquareAt(float worldX, float worldZ)
    {
        Square bestSq = null;
        float maxY = -999f;
        
        foreach(var sq in MapGenerator.AllSquares.Values)
        {
            if (Mathf.Abs(sq.transform.position.x - worldX) < 0.2f &&
                Mathf.Abs(sq.transform.position.z - worldZ) < 0.2f)
            {
                if (sq.transform.position.y > maxY)
                {
                    maxY = sq.transform.position.y;
                    bestSq = sq;
                }
            }
        }
        return bestSq;
    }
}
</file>

<file path="lib/main.dart">
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:shared_preferences/shared_preferences.dart';

// å„ç”»é¢ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import 'screens/title_screen.dart';
import 'screens/lobby_screen.dart';
import 'screens/waiting_room_screen.dart';
import 'screens/game_screen.dart';

// ã‚µãƒ¼ãƒ“ã‚¹ãƒ»ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import 'services/socket_service.dart';
import 'services/unity_bridge_service.dart';
import 'providers/user_provider.dart';
import 'providers/group_provider.dart';
import 'providers/lobby_view_model.dart';

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ¼
final GlobalKey<NavigatorState> navigatorKey = GlobalKey<NavigatorState>();

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // ç”»é¢ã®å‘ãã‚’æ¨ªå‘ãã«å›ºå®šï¼ˆã‚²ãƒ¼ãƒ ã®ãŸã‚ï¼‰
  await SystemChrome.setPreferredOrientations([
    DeviceOrientation.landscapeLeft,
    DeviceOrientation.landscapeRight,
  ]);

  final prefs = await SharedPreferences.getInstance();
  final socketService = SocketService();
  final unityBridge = UnityBridgeService();
  
  // Socketé€šä¿¡ã®åˆæœŸåŒ–
  socketService.init("ws://localhost:3000");

  runApp(
    MultiProvider(
      providers: [
        // ã‚¤ãƒ³ãƒ•ãƒ©å±¤
        Provider.value(value: socketService),
        Provider.value(value: unityBridge),
        
        // çŠ¶æ…‹ç®¡ç†å±¤
        ChangeNotifierProvider(create: (_) => UserProvider(unityBridge, prefs)),
        ChangeNotifierProvider(create: (_) => GroupProvider()),
        ChangeNotifierProvider(create: (_) => LobbyViewModel()),
      ],
      child: const MyApp(),
    ),
  );
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      navigatorKey: navigatorKey,
      debugShowCheckedModeBanner: false,
      title: 'ãƒ–ãƒ­ãƒƒã‚¯ãŠã«',
      theme: ThemeData(
        useMaterial3: true,
        primarySwatch: Colors.cyan,
        scaffoldBackgroundColor: Colors.white,
      ),
      // åˆæœŸç”»é¢
      home: const TitleScreen(),
      // ç”»é¢é·ç§»å®šç¾©
      routes: {
        '/lobby': (context) => const LobbyScreen(),
        '/waiting': (context) => const WaitingRoomScreen(),
        '/game': (context) => const GameScreen(),
      },
    );
  }
}
</file>

</files>
